<!DOCTYPE html>

<html lang="en" class="light-style layout-menu-fixed layout-compact layout-menu-collapsed" dir="ltr"
    data-theme="theme-default" data-assets-path="/assets/" data-template="vertical-menu-template-free">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Dashboard - Analytics </title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon/favicon.ico" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet" />

    <!-- Jeferson: Icones -->
    <link rel="stylesheet" href="/assets/vendor/fonts/boxicons.css" />

    <!-- Jeferson: Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Jeferson: Tema opcional para Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

    <!-- Core CSS -->
    <link rel="stylesheet" href="/assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="/assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="/assets/vendor/libs/apex-charts/apex-charts.css" />

    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="/assets/vendor/js/helpers.js"></script>
    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="/assets/js/config.js"></script>

    <style>
        /* Linha “detalhes” do accordion dentro da tabela */
        .customer-details-row td {
            padding: 0 !important;
            border-top: 0 !important;
        }

        /* Botão de expandir com rotação do ícone */
        .customer-expand i {
            transition: transform .18s ease;
        }

        .customer-expand[aria-expanded="true"] i {
            transform: rotate(180deg);
        }

        /* Lista de plataformas mais “compacta” dentro do accordion */
        .customer-platform-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(67, 89, 113, 0.12);
        }

        .customer-platform-item:last-child {
            border-bottom: 0;
        }

        /* Ícones das plataformas no resumo */
        .platform-mini-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
            display: inline-block;
        }

        .customer-platform-actions .form-check {
            margin: 0;
        }

        .customer-platform-actions .btn {
            line-height: 1;
        }
    </style>
    <!-- manter layout correto quando menu estiver colapsado -->
    <style>
        /* ho.ko fix — manter layout correto quando menu estiver colapsado */
        @media (min-width: 1200px) {

            /* Quando estiver colapsado, a página precisa continuar “respeitando” 5.25rem */
            html.layout-menu-fixed.layout-menu-collapsed .layout-page,
            html.layout-menu-fixed-offcanvas.layout-menu-collapsed .layout-page {
                padding-left: 5.25rem;
            }

            /* Navbar fixa também precisa acompanhar */
            html.layout-navbar-fixed.layout-menu-collapsed .layout-content-navbar:not(.layout-without-menu) .layout-navbar,
            html.layout-menu-fixed.layout-navbar-fixed.layout-menu-collapsed .layout-content-navbar:not(.layout-without-menu) .layout-navbar,
            html.layout-menu-fixed-offcanvas.layout-navbar-fixed.layout-menu-collapsed .layout-content-navbar:not(.layout-without-menu) .layout-navbar {
                left: 5.25rem;
            }

            /* Footer fixo também */
            html.layout-footer-fixed.layout-menu-collapsed .layout-wrapper:not(.layout-without-menu) .content-footer {
                left: 5.25rem;
            }
        }
    </style>
</head>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">

            <!-- Menu -->
            <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
                <div class="app-brand demo">
                    <a href="dashboardPage.html" class="app-brand-link">
                        <div class="avatar">
                            <img src="/assets/img/favicon/favicon.ico" alt class="w-px-40 h-auto rounded-circle" />
                        </div>
                    </a>

                    <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
                        <i class="bx bx-chevron-left bx-sm align-middle"></i>
                    </a>
                </div>

                <div class="menu-inner-shadow"></div>

                <ul class="menu-inner py-1">

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Páginas</span>
                    </li>
                    <!-- Apps -->
                    <li class="menu-item ">
                        <a href="/dashboardPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bx bx-layout"></i>
                            <div data-i18n="Email">Dashboard</div>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="/analyzesPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-robot"></i>
                            <div data-i18n="Calendar">Análises</div>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="/foodModelPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-menu-up"></i>
                            <div data-i18n="Chat">Alimentar modelo</div>
                        </a>
                    </li>

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Plataformas & Clientes</span>
                    </li>

                    <li class="menu-item active">
                        <a href="myCustomersPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-people"></i>
                            <div data-i18n="Without menu">Meus Clientes</div>
                        </a>
                    </li>

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Equipe</span>
                    </li>

                    <li class="menu-item">
                        <a href="/kanbanPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bx bx-grid"></i>
                            <div data-i18n="Kanban">Kanban</div>
                            <!--<div class="badge bg-label-primary fs-tiny rounded-pill ms-auto">Pro</div>-->
                        </a>
                    </li>

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Outros</span>
                    </li>

                    <li class="menu-item">
                        <a href="javascript:void(0);" class="menu-link menu-toggle">
                            <i class="menu-icon tf-icons bi bi-gear"></i>
                            <div data-i18n="Chat">Configurações</div>
                        </a>

                        <ul class="menu-sub">
                            <li class="menu-item">
                                <a href="/settingsAccountPage.html" class="menu-link">
                                    <div data-i18n="Without menu">Conta</div>
                                </a>
                            </li>
                            <!--<li class="menu-item">
                                <a href="/notificationsPage.html" class="menu-link">
                                    <div data-i18n="Without navbar">Notificações</div>
                                </a>
                            </li>-->
                        </ul>
                    </li>

                    <li class="menu-item">
                        <a href="#" class="menu-link" data-bs-toggle="modal" data-bs-target="#contactModal">
                            <i class="menu-icon tf-icons bi bi-headset"></i>
                            <div data-i18n="Chat">Fale conosco</div>
                        </a>
                    </li>

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Segurança</span>
                    </li>

                    <li class="menu-item">
                        <a href="/termsUse.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-file-earmark-lock"></i>
                            <div data-i18n="Chat">Termos de Uso</div>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="/privacyPolicyPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-shield-lock"></i>
                            <div data-i18n="Chat">Política de Privacidade</div>
                        </a>
                    </li>

                </ul>
            </aside>
            <!-- / Menu -->

            <!-- Layout container -->
            <div class="layout-page">

                <!-- Navbar -->
                <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
                    id="layout-navbar">
                    <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
                        <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
                            <i class="bx bx-menu bx-sm"></i>
                        </a>
                    </div>

                    <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">

                        <ul class="navbar-nav flex-row align-items-center ms-auto">
                            <!-- User -->
                            <li class="nav-item navbar-dropdown dropdown-user dropdown">
                                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);"
                                    data-bs-toggle="dropdown">
                                    <div class="avatar avatar-online">
                                        <img src="/assets/img/favicon/favicon.ico" alt
                                            class="w-px-40 h-auto rounded-circle user-profile-avatar" />
                                    </div>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="#">
                                            <div class="d-flex">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="avatar avatar-online">
                                                        <img src="/assets/img/favicon/favicon.ico" alt
                                                            class="w-px-40 h-auto rounded-circle user-profile-avatar" />
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <span class="fw-medium d-block" id="user-name"></span>
                                                    <small class="text-muted">Admin</small>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    <li>
                                        <div class="dropdown-divider"></div>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="/settingsAccountPage.html">
                                            <i class="bx bx-user me-2"></i>
                                            <span class="align-middle">Perfil</span>
                                        </a>
                                    </li>
                                    <!--<li>
                                        <a class="dropdown-item" href="#">
                                            <span class="d-flex align-items-center align-middle">
                                                <i class="flex-shrink-0 bx bx-credit-card me-2"></i>
                                                <span class="flex-grow-1 align-middle ms-1">Billing</span>
                                                <span
                                                    class="flex-shrink-0 badge badge-center rounded-pill bg-danger w-px-20 h-px-20">4</span>
                                            </span>
                                        </a>
                                    </li>-->
                                    <li>
                                        <div class="dropdown-divider"></div>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="javascript:void(0);" id="log-out">
                                            <i class="bx bx-power-off me-2"></i>
                                            <span class="align-middle">Sair</span>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                            <!--/ User -->
                        </ul>
                    </div>
                </nav>

                <div class="container pt-4">
                    <div class="d-flex align-items-center justify-content-between py-2">
                        <h4 class="mb-0">
                            <span class="text-muted fw-light">Plataformas & Páginas /</span> Meus Clientes
                        </h4>

                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#modalAddCustomer">
                            <i class="bx bx-plus me-1"></i> Novo Cliente
                        </button>
                    </div>

                    <div id="alert-container"></div>
                    <!-- Hoverable Table rows -->
                    <div class="card">
                        <div class="table-responsive text-nowrap">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Clientes</th>
                                        <th>Telefone</th>
                                        <th>Email</th>
                                        <th>Plataformas</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody class="table-border-bottom-0" id="clients-table-body">
                                    <template id="customerRowTemplate">
                                        <!-- Linha principal -->
                                        <tr>
                                            <td class="align-middle">
                                                <button type="button"
                                                    class="btn btn-sm btn-icon btn-outline-secondary me-2 customer-expand"
                                                    data-bs-toggle="collapse" data-bs-target="#__CUSTOMER_COLLAPSE_ID__"
                                                    aria-expanded="false" aria-controls="__CUSTOMER_COLLAPSE_ID__"
                                                    title="Ver plataformas do cliente">
                                                    <i class="bx bx-chevron-down"></i>
                                                </button>
                                                <span class="fw-medium">__CUSTOMER_NAME__</span>
                                            </td>

                                            <td class="align-middle">__CUSTOMER_PHONE__</td>

                                            <td class="align-middle">__CUSTOMER_EMAIL__</td>

                                            <td class="align-middle">
                                                <div class="d-inline-flex align-items-center gap-1">
                                                    <!-- JS injeta ícones -->
                                                </div>
                                            </td>

                                            <td class="align-middle">
                                                <span class="badge bg-label-secondary">SEM CONEXÃO</span>
                                            </td>

                                            <td class="align-middle">
                                                <!-- Mantém ações (sem funcionalidade nesta task) -->
                                                <div class="dropdown">
                                                    <button class="btn p-0" type="button" data-bs-toggle="dropdown"
                                                        aria-expanded="false">
                                                        <i class="bx bx-dots-vertical-rounded"></i>
                                                    </button>

                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li>
                                                            <a class="dropdown-item edit_client"
                                                                href="javascript:void(0);" data-id="">
                                                                <i class="bx bx-edit-alt me-2"></i>Editar
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item remove-client"
                                                                href="javascript:void(0);" data-id="">
                                                                <i class="bx bx-trash me-2"></i>Remover
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Linha detalhe (accordion) -->
                                        <tr class="customer-details-row">
                                            <td colspan="6">
                                                <div class="collapse" id="__CUSTOMER_COLLAPSE_ID__"
                                                    data-bs-parent="#clients-table-body">
                                                    <div class="p-3 pt-0">
                                                        <div class="card shadow-none border mb-0">
                                                            <div class="card-body">
                                                                <div
                                                                    class="d-flex align-items-start justify-content-between mb-2">
                                                                    <div>
                                                                        <h6 class="mb-1">Plataformas do cliente</h6>
                                                                        <small class="text-muted">Nesta task, apenas
                                                                            listagem do cliente. Integrações virão
                                                                            depois.</small>
                                                                    </div>
                                                                    <span
                                                                        class="badge bg-label-secondary">Integrações</span>
                                                                </div>

                                                                <!-- Placeholder que o JS pode preencher -->
                                                                <div class="customer-platforms-container">
                                                                    <div class="alert alert-light border mb-0 py-2">
                                                                        <small class="text-muted">Em breve: conectar e
                                                                            gerenciar plataformas por cliente.</small>
                                                                    </div>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!--/ Hoverable Table rows -->
                </div>
                <!-- / Intervalo de busca -->
                <!-- / Navbar -->

                <!-- Modal de Confirmação -->
                <div class="modal fade" id="modalToggle" aria-labelledby="modalToggleLabel" tabindex="-1"
                    style="display: none" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalToggleLabel">Desconectar Plataforma</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Tem certeza que deseja desconectar sua conta desta plataforma?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger">Desconectar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal de Edição de Cliente -->
                <div class="modal fade" id="modalEditClient" aria-labelledby="modalEditClientLabel" tabindex="-1"
                    style="display: none" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalEditClientLabel">Editar Cliente</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editClientForm">
                                    <input type="hidden" id="editClientId" />
                                    <div class="mb-3">
                                        <label class="form-label" for="editClientName">Nome</label>
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="bx bx-user"></i></span>
                                            <input type="text" class="form-control" id="editClientName" required />
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="editClientCompany">Empresa</label>
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="bx bx-buildings"></i></span>
                                            <input type="text" class="form-control" id="editClientCompany" />
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="editClientEmail">Email</label>
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="bx bx-envelope"></i></span>
                                            <input type="email" class="form-control" id="editClientEmail" required />
                                        </div>
                                    </div>

                                    <div class="mb-0">
                                        <label class="form-label" for="editClientPhone">Telefone</label>
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="bx bx-phone"></i></span>
                                            <input type="text" class="form-control" id="editClientPhone"
                                                placeholder="(00) 0 0000-0000" />
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="confirmEditClient">
                                    <span class="btn-text">Confirmar Modificação</span>
                                    <span class="spinner-border spinner-border-sm ms-2 d-none" id="editCustomerSpinner"
                                        role="status" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Fale Conosco -->
                <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">

                            <div class="modal-header">
                                <h5 class="modal-title" id="contactModalLabel">
                                    <i class="bi bi-headset me-2"></i>Fale Conosco
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Fechar"></button>
                            </div>

                            <div class="modal-body">
                                <p class="mb-2"><i
                                        class="bi bi-telephone me-2 text-primary"></i><strong>Telefone:</strong> +55 19
                                    99714-8221 </p>
                                <p class="mb-2"><i class="bi bi-envelope me-2 text-danger"></i><strong>Email:</strong>
                                    contato@hokocomunicacao.com.br</p>
                                <p class="mb-0"><i
                                        class="bi bi-geo-alt me-2 text-success"></i><strong>Endereço:</strong> R.
                                    Comendador Tórlogo Dauntre, n.74 Sala 1207
                                    13.025-270
                                    Cambui, Campinas SP</p>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Modal: Novo Cliente -->
                <div class="modal fade" id="modalAddCustomer" aria-labelledby="modalAddCustomerLabel" tabindex="-1"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">

                            <div class="modal-header">
                                <h5 class="modal-title" id="modalAddCustomerLabel">Novo Cliente</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Fechar"></button>
                            </div>

                            <form id="addCustomerForm">
                                <div class="modal-body">

                                    <div class="alert alert-info py-2">
                                        <small>
                                            Crie o cliente agora. E conecte as plataformas após a criação.
                                        </small>
                                    </div>

                                    <!-- Baseado no customersPage.html (form original), só que em modal -->
                                    <div class="mb-3">
                                        <label class="form-label" for="addCustomerName">Nome</label>
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="bx bx-user"></i></span>
                                            <input type="text" class="form-control" id="addCustomerName"
                                                placeholder="Fulano Silva" required />
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="addCustomerCompany">Empresa</label>
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="bx bx-buildings"></i></span>
                                            <input type="text" class="form-control" id="addCustomerCompany"
                                                placeholder="XPTO Inc." />
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label" for="addCustomerEmail">Email</label>
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="bx bx-envelope"></i></span>
                                            <input type="email" class="form-control" id="addCustomerEmail"
                                                placeholder="fulano@exemplo.com" required />
                                        </div>
                                        <div class="form-text">Você pode usar letras, números e pontos</div>
                                    </div>

                                    <div class="mb-0">
                                        <label class="form-label" for="addCustomerPhone">Telefone</label>
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="bx bx-phone"></i></span>
                                            <input type="text" class="form-control" id="addCustomerPhone"
                                                placeholder="(00) 0 0000-0000" />
                                        </div>
                                    </div>

                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-label-secondary"
                                        data-bs-dismiss="modal">Cancelar</button>

                                    <button type="submit" class="btn btn-primary" id="btnCreateCustomer">
                                        <span class="btn-text">Criar Cliente</span>
                                        <span class="spinner-border spinner-border-sm ms-2 d-none"
                                            id="createCustomerSpinner" role="status" aria-hidden="true"></span>
                                    </button>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>

                <!-- Modal: Desativar Cliente -->
                <div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Desativar cliente</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Fechar"></button>
                            </div>

                            <div class="modal-body">
                                <input type="hidden" id="delete_id_customer" />
                                <p class="mb-0">
                                    O cliente será desativado. Ele continuará aparecendo na lista como
                                    <strong>Desativado</strong>, mas não poderá ser aberto, editado ou conectado
                                    às plataformas. Seus dados e históricos só serão removidos definitivamente
                                    ao final do ciclo de cobrança. Deseja continuar?
                                </p>
                                <div id="deleteCustomerAlert" class="mt-3"></div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteCustomerBtn">
                                    <span id="deleteCustomerBtnText">Desativar</span>
                                    <span id="deleteCustomerSpinner" class="spinner-border spinner-border-sm d-none"
                                        role="status" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Modal: Assinatura / Pagamento -->
    <div class="modal fade" id="billingModal" tabindex="-1" aria-labelledby="billingModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="billingModalLabel">
                        <i class="bx bx-credit-card me-2"></i> Assinatura da plataforma
                    </h5>
                    <!-- Sem botão de fechar para forçar decisão -->
                </div>

                <div class="modal-body">
                    <div id="billing-alert" class="alert alert-info" role="alert" style="display:none;"></div>

                    <!-- Status atual -->
                    <div id="billing-status" class="mb-3">
                        <small class="text-muted">Verificando sua assinatura…</small>
                    </div>

                    <!-- Cupom 
                    <div class="mb-3">
                        <label for="couponInput" class="form-label">Cupom (opcional)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bx bx-purchase-tag-alt"></i></span>
                            <input type="text" id="couponInput" class="form-control" placeholder="EX.: BEMVINDO10">
                        </div>
                    </div>-->

                    <!-- Planos -->
                    <div class="mb-2">
                        <h6 class="mb-1">Escolha um plano</h6>
                        <!--<small class="text-muted">Os valores são carregados automaticamente dos seus planos.</small>-->
                    </div>
                    <div id="plansGrid" class="row g-3">
                        <!-- Cartões de planos serão injetados aqui via JS -->
                    </div>
                </div>

                <div class="modal-footer d-flex justify-content-between">
                    <button id="openPortalBtn" type="button" class="btn btn-outline-secondary" disabled>
                        Gerenciar pagamento (Portal)
                    </button>
                    <div class="d-flex gap-2">
                        <a href="/settingsAccountPage.html" class="btn btn-light">Ver opções completas</a>
                        <button id="closeBillingBtn" type="button" class="btn btn-secondary">Fechar</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal: Selecionar recurso Meta (Página FB / Conta IG) -->
    <div class="modal fade" id="metaResourceModal" tabindex="-1" aria-labelledby="metaResourceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="metaResourceModalLabel">Conectar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label" id="metaResourceLabel">Selecione</label>
                    <select class="form-select" id="metaResourceSelect"></select>
                    <div id="metaResourceError" class="text-danger small mt-2 d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="metaResourceSaveBtn">
                        <span class="btn-text">Conectar</span>
                        <span class="spinner-border spinner-border-sm ms-2 d-none" id="metaResourceSaveSpinner"
                            role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Remover plataforma -->
    <div class="modal fade" id="removePlatformModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Remover plataforma</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="removePlatformCustomerId">
                    <input type="hidden" id="removePlatformName">
                    <p class="mb-0">Confirma remover esta plataforma do cliente?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="removePlatformConfirmBtn">Remover</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Jeferson: container para mensagem -->
    <div id="alert-container"></div>

    <!-- Core JS -->
    <!-- build:js assets/vendor/js/core.js -->

    <script src="/assets/vendor/libs/jquery/jquery.js"></script>
    <script src="/assets/vendor/libs/popper/popper.js"></script>
    <script src="/assets/vendor/js/bootstrap.js"></script>
    <script src="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="/assets/vendor/js/menu.js"></script>

    <!-- endbuild -->

    <!-- Vendors JS -->
    <script src="/assets/vendor/libs/apex-charts/apexcharts.js"></script>

    <!-- Main JS -->
    <script src="/assets/js/main.js"></script>
    <!--<script src="/assets/js/myCustomerPage.js"></script>-->
    <script src="/assets/js/checkPayments.js"></script>
    <script src="/assets/js/notifications.js"></script>
    <!-- Page JS -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("addCustomerForm");
            const modalEl = document.getElementById("modalAddCustomer");
            const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

            const alertContainer = document.getElementById("alert-container");

            const btn = document.getElementById("btnCreateCustomer");
            const spinner = document.getElementById("createCustomerSpinner");
            const btnText = btn ? btn.querySelector(".btn-text") : null;

            function showAlert(type, message) {
                if (!alertContainer) return;
                alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>
                `;
            }

            function setLoading(isLoading) {
                if (!btn) return;
                btn.disabled = isLoading;
                if (spinner) spinner.classList.toggle("d-none", !isLoading);
                if (btnText) btnText.textContent = isLoading ? "Criando..." : "Criar Cliente";
            }

            if (!form) return;

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const name = document.getElementById("addCustomerName")?.value?.trim();
                const company = document.getElementById("addCustomerCompany")?.value?.trim() || null;
                const email = document.getElementById("addCustomerEmail")?.value?.trim();
                const phone = document.getElementById("addCustomerPhone")?.value?.trim() || null;

                if (!name || !email) {
                    showAlert("danger", "Nome e email são obrigatórios.");
                    return;
                }

                setLoading(true);

                try {
                    const resp = await fetch("/customer/add", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ name, company, email, phone })
                    });

                    const data = await resp.json();

                    if (!resp.ok || !data.success) {
                        throw new Error(data.message || "Erro ao criar cliente.");
                    }

                    // fecha modal + limpa form
                    form.reset();
                    if (modal) modal.hide();

                    showAlert("success", "Cliente criado com sucesso!");

                    // simples e suficiente por agora
                    setTimeout(() => location.reload(), 600);
                } catch (err) {
                    showAlert("danger", err.message || "Erro ao criar cliente.");
                } finally {
                    setLoading(false);
                }
            });
        });
    </script>
    <!-- myCustomerPage.html -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const tbody = document.getElementById("clients-table-body");
            const tpl = document.getElementById("customerRowTemplate");

            const platformIcons = {
                facebook: "facebook.png",
                instagram: "instagram.png",
                linkedin: "linkedin.png",
                google_analytics: "google-analytics.png",
                youtube: "youtube.png"
            };

            function safeText(v) {
                return (v === null || v === undefined || v === "") ? "-" : String(v);
            }

            function badgeStatus(connected) {
                return connected
                    ? '<span class="badge bg-label-success me-1">Conectado</span>'
                    : '<span class="badge bg-label-secondary me-1">Pendente</span>';
            }

            function integrationOf(integrations, name) {
                return (integrations || []).find(i => (i.platform || "").toLowerCase() === name);
            }

            function renderPlatformIcons(integrations) {
                const connected = (integrations || []).filter(i => (i.status || "").toLowerCase() === "connected");
                const uniquePlatforms = [...new Set(connected.map(i => i.platform))];

                if (!uniquePlatforms.length) return '<span class="text-muted small">—</span>';

                return uniquePlatforms.map(p => {
                    const key = String(p).toLowerCase();
                    const icon = platformIcons[key];
                    if (!icon) return "";
                    return `
                    <span class="me-1" title="${key}">
                        <img class="platform-mini-icon" src="/assets/img/icons/brands/${icon}" alt="${key}">
                    </span>
                    `;
                }).join("");
            }

            function badgeForIntegrationStatus(status) {
                const s = (status || "").toLowerCase();
                if (s === "connected") return '<span class="badge bg-label-success">Conectado</span>';
                if (s === "authorized") return '<span class="badge bg-label-info">Autorizado</span>';
                return '<span class="badge bg-label-secondary">Não autorizado</span>';
            }

            function renderMetaRow(customer, platform) {
                const integ = integrationOf(customer.integrations, platform);
                const status = (integ?.status || "").toLowerCase();

                const connectedName = integ?.resource_name ? `Conectado: <strong>${integ.resource_name}</strong>` : "";
                const subtitle =
                    status === "connected" ? connectedName :
                        status === "authorized" ? "OAuth OK. Falta selecionar o recurso." :
                            "Faça o OAuth para habilitar a seleção.";

                const action =
                    status === "connected" || status === "authorized"
                        ? `<button class="btn btn-sm btn-outline-primary js-meta-select"
                                data-customer="${customer.id_customer}"
                                data-platform="${platform}">
                                ${status === "connected" ? "Trocar" : "Conectar"}
                                </button>`
                        : `<button class="btn btn-sm btn-primary js-meta-authorize"
                                data-customer="${customer.id_customer}">
                            Autorizar
                            </button>`
                    ;

                const removeBtn =
                    status === "connected" || status === "authorized"
                        ? `<button class="btn btn-sm btn-outline-danger js-platform-remove"
                                data-customer="${customer.id_customer}"
                                data-platform="${platform}">
                                Remover
                            </button>`
                        : "";


                const label = platform === "facebook" ? "Facebook" : "Instagram";

                return `
                    <div class="customer-platform-item">
                    <div class="d-flex align-items-center justify-content-between gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <img class="platform-mini-icon" style="width:22px;height:22px"
                                src="/assets/img/icons/brands/${platformIcons[platform]}" alt="${label}">
                        <div>
                            <div class="fw-semibold">${label}</div>
                            <small class="text-muted">${subtitle || ""}</small>
                        </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            ${badgeForIntegrationStatus(integ?.status)}
                            ${removeBtn}
                            ${action}
                        </div>
                    </div>
                    </div>
                `;
            }

            function renderLinkedinRow(customer) {
                const integ = integrationOf(customer.integrations, "linkedin");
                const status = (integ?.status || "").toLowerCase();

                let subtitle = "Faça a autorização para conectar uma organização.";
                if (status === "authorized") {
                    subtitle = "OAuth autorizado. Falta selecionar a organização.";
                } else if (status === "connected") {
                    subtitle = integ?.resource_name
                        ? `Conectado: <strong>${integ.resource_name}</strong>`
                        : "Conectado.";
                }

                const action =
                    status === "connected" || status === "authorized"
                        ? `<button class="btn btn-sm btn-outline-primary js-linkedin-select"
                            data-customer="${customer.id_customer}">
                            ${status === "connected" ? "Trocar" : "Conectar"}
                            </button>`
                        : `<button class="btn btn-sm btn-primary js-linkedin-authorize"
                            data-customer="${customer.id_customer}">
                            Autorizar
                        </button>`;

                const removeBtn =
                    status === "connected" || status === "authorized"
                        ? `<button class="btn btn-sm btn-outline-danger js-platform-remove"
                                data-customer="${customer.id_customer}"
                                data-platform="linkedin">
                                Remover
                            </button>`
                        : "";

                return `
                    <div class="customer-platform-item">
                    <div class="d-flex align-items-center justify-content-between gap-2">
                        <div class="d-flex align-items-center gap-2">
                        <img class="platform-mini-icon" style="width:22px;height:22px"
                            src="/assets/img/icons/brands/${platformIcons.linkedin}" alt="LinkedIn">
                        <div>
                            <div class="fw-semibold">LinkedIn</div>
                            <small class="text-muted">${subtitle}</small>
                        </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                        ${badgeForIntegrationStatus(integ?.status)}
                        ${removeBtn}
                        ${action}
                        </div>
                    </div>
                    </div>
                `;
            }

            function renderGaRow(customer) {
                const integ = integrationOf(customer.integrations, "google_analytics");
                const status = (integ?.status || "").toLowerCase();

                const daysLeft = integ?.expires_at ? Math.ceil((new Date(integ.expires_at) - Date.now()) / 86400000) : null;
                const expBadge = daysLeft !== null && daysLeft <= 7 ? `<span class="badge bg-label-warning">Expira em ${daysLeft}d</span>` : "";
                const renewBtn = daysLeft !== null && daysLeft <= 7 && (status === "authorized" || status === "connected")
                    ? `<button class="btn btn-sm btn-icon btn-outline-warning js-ga-renew" title="Renovar" data-customer="${customer.id_customer}"><i class="bx bx-refresh"></i></button>`
                    : `<button class="btn btn-sm btn-icon btn-outline-warning" style="visibility:hidden;"><i class="bx bx-refresh"></i></button>`;

                let subtitle = "Faça a autorização para listar properties.";
                if (status === "authorized") subtitle = "OAuth autorizado. Falta selecionar a property.";
                else if (status === "connected") subtitle = integ?.resource_name ? `Conectado: <strong>${integ.resource_name}</strong>` : "Conectado.";

                const action =
                    status === "connected" || status === "authorized"
                        ? `<button class="btn btn-sm btn-outline-primary js-ga-select" data-customer="${customer.id_customer}">${status === "connected" ? "Trocar" : "Conectar"}</button>`
                        : `<button class="btn btn-sm btn-primary js-ga-authorize" data-customer="${customer.id_customer}">Autorizar</button>`;
                const removeBtn =
                    status === "connected" || status === "authorized"
                        ? `<button class="btn btn-sm btn-outline-danger js-platform-remove"
                                data-customer="${customer.id_customer}"
                                data-platform="google_analytics">
                                Remover
                            </button>`
                        : "";
                return `
                    <div class="customer-platform-item">
                    <div class="d-flex align-items-center justify-content-between gap-2">
                        <div class="d-flex align-items-center gap-2">
                        <img class="platform-mini-icon" style="width:22px;height:22px" src="/assets/img/icons/brands/${platformIcons.google_analytics}" alt="Google Analytics">
                        <div>
                            <div class="fw-semibold">Google Analytics</div>
                            <small class="text-muted">${subtitle}</small>
                        </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                        ${badgeForIntegrationStatus(integ?.status)}
                        
                        
                        ${removeBtn}
                        ${action}
                        </div>
                    </div>
                    </div>
                `;
                /** Antes:
                 * <div class="d-flex align-items-center gap-2">
                        ${badgeForIntegrationStatus(integ?.status)}
                        ${expBadge}
                        ${renewBtn}
                        ${removeBtn}
                        ${action}
                        </div>
                */
            }

            function renderYoutubeRow(customer) {
                const integ = integrationOf(customer.integrations, "youtube");
                const status = (integ?.status || "").toLowerCase();

                const daysLeft = integ?.expires_at ? Math.ceil((new Date(integ.expires_at) - Date.now()) / 86400000) : null;
                const expBadge = daysLeft !== null && daysLeft <= 7 ? `<span class="badge bg-label-warning">Expira em ${daysLeft}d</span>` : "";
                const renewBtn = daysLeft !== null && daysLeft <= 7 && (status === "authorized" || status === "connected")
                    ? `<button class="btn btn-sm btn-icon btn-outline-warning js-yt-renew" title="Renovar" data-customer="${customer.id_customer}"><i class="bx bx-refresh"></i></button>`
                    : `<button class="btn btn-sm btn-icon btn-outline-warning" style="visibility:hidden;"><i class="bx bx-refresh"></i></button>`;

                let subtitle = "Faça a autorização para listar canais.";
                if (status === "authorized") subtitle = "OAuth autorizado. Falta selecionar o canal.";
                else if (status === "connected") subtitle = integ?.resource_name ? `Conectado: <strong>${integ.resource_name}</strong>` : "Conectado.";

                const action =
                    status === "connected" || status === "authorized"
                        ? `<button class="btn btn-sm btn-outline-primary js-yt-select" data-customer="${customer.id_customer}">${status === "connected" ? "Trocar" : "Conectar"}</button>`
                        : `<button class="btn btn-sm btn-primary js-yt-authorize" data-customer="${customer.id_customer}">Autorizar</button>`;

                const removeBtn =
                    status === "connected" || status === "authorized"
                        ? `<button class="btn btn-sm btn-outline-danger js-platform-remove"
                                data-customer="${customer.id_customer}"
                                data-platform="youtube">
                                Remover
                            </button>`
                        : "";

                return `
                    <div class="customer-platform-item">
                    <div class="d-flex align-items-center justify-content-between gap-2">
                        <div class="d-flex align-items-center gap-2">
                        <img class="platform-mini-icon" style="width:22px;height:22px" src="/assets/img/icons/brands/${platformIcons.youtube}" alt="YouTube">
                        <div>
                            <div class="fw-semibold">YouTube</div>
                            <small class="text-muted">${subtitle}</small>
                        </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                        ${badgeForIntegrationStatus(integ?.status)}


                        ${removeBtn}
                        ${action}
                        </div>
                    </div>
                    </div>
                `;
                /** Antes:
                 * <div class="d-flex align-items-center gap-2">
                        ${badgeForIntegrationStatus(integ?.status)}
                        ${expBadge}
                        ${renewBtn}
                        ${removeBtn}
                        ${action}
                        </div>
                */
            }

            function renderIntegrationsPanel(customer) {
                return `
                    <div class="alert alert-light border mb-3 py-2">
                    <small class="text-muted">
                        Fluxo: 1) Autorizar (OAuth) &rarr; 2) Selecionar recurso no modal &rarr; 3) Salvar e puxar históricos.
                    </small>
                    </div>

                    <h6 class="mb-2">Meta (Facebook / Instagram)</h6>
                    ${renderMetaRow(customer, "facebook")}
                    ${renderMetaRow(customer, "instagram")}

                    <h6 class="mb-2 mt-4">Google</h6>
                    ${renderGaRow(customer)}
                    ${renderYoutubeRow(customer)}

                    <h6 class="mb-2 mt-4">LinkedIn</h6>
                    ${renderLinkedinRow(customer)}

                `;
            }

            // Modal Meta
            const metaModalEl = document.getElementById("metaResourceModal");
            const metaModal = metaModalEl ? new bootstrap.Modal(metaModalEl) : null;
            const metaSelect = document.getElementById("metaResourceSelect");
            const metaTitle = document.getElementById("metaResourceModalLabel");
            const metaLabel = document.getElementById("metaResourceLabel");
            const metaError = document.getElementById("metaResourceError");
            const metaSaveBtn = document.getElementById("metaResourceSaveBtn");
            const metaSaveSpinner = document.getElementById("metaResourceSaveSpinner");
            const metaSaveText = metaSaveBtn ? metaSaveBtn.querySelector(".btn-text") : null;

            function setMetaLoading(loading, text) {
                if (metaSaveBtn) metaSaveBtn.disabled = loading;
                if (metaSaveSpinner) metaSaveSpinner.classList.toggle("d-none", !loading);
                if (metaSaveText && text) metaSaveText.textContent = text;
            }

            function showMetaError(msg) {
                if (!metaError) return;
                metaError.textContent = msg || "";
                metaError.classList.toggle("d-none", !msg);
            }

            async function openMetaResourceModal(id_customer, platform) {
                if (!metaModal) return;

                showMetaError("");
                metaSelect.innerHTML = "";
                setMetaLoading(true, "Carregando...");

                metaTitle.textContent = platform === "facebook" ? "Conectar Página do Facebook" : "Conectar Conta do Instagram";
                metaLabel.textContent = platform === "facebook" ? "Selecione a página" : "Selecione a conta";

                metaModal.show();

                try {
                    const resp = await fetch(`/api/meta/pages?id_customer=${encodeURIComponent(id_customer)}`);
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data.message || "Erro ao listar recursos Meta");

                    const list = platform === "facebook" ? (data.facebook || []) : (data.instagram || []);
                    if (!list.length) {
                        metaSelect.innerHTML = `<option value="">Nenhum recurso encontrado</option>`;
                        setMetaLoading(false, "Conectar");
                        return;
                    }

                    metaSelect.innerHTML = list.map(item => `
                        <option
                            value="${item.id_page}"
                            data-name="${(item.name || "").replace(/"/g, "&quot;")}"
                            data-token="${(item.access_token || "").replace(/"/g, "&quot;")}"
                        >${item.name}</option>
                        `).join("");

                    setMetaLoading(false, "Conectar");

                    metaSaveBtn.onclick = async () => {
                        showMetaError("");
                        const opt = metaSelect.options[metaSelect.selectedIndex];
                        const resource_id = opt?.value;
                        const resource_name = opt?.dataset?.name || opt?.textContent || null;
                        const resource_access_token = opt?.dataset?.token;

                        if (!resource_id || !resource_access_token) {
                            showMetaError("Seleção inválida.");
                            return;
                        }

                        try {
                            setMetaLoading(true, "Conectando...");

                            const r = await fetch("/api/meta/connect", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    id_customer,
                                    platform,
                                    resource_id,
                                    resource_name,
                                    resource_access_token
                                })
                            });

                            const j = await r.json();
                            if (!r.ok || !j.success) throw new Error(j.message || "Erro ao conectar");

                            metaModal.hide();
                            window.location.href = `/myCustomersPage.html?open=${encodeURIComponent(id_customer)}`;
                        } catch (e) {
                            showMetaError(e.message || "Erro ao conectar.");
                        } finally {
                            setMetaLoading(false, "Conectar");
                        }
                    };
                } catch (e) {
                    showMetaError(e.message || "Erro ao carregar recursos.");
                    setMetaLoading(false, "Conectar");
                }
            }

            async function openLinkedinOrganizationModal(id_customer) {
                if (!metaModal) return;

                showMetaError("");
                metaSelect.innerHTML = "";
                setMetaLoading(true, "Carregando...");

                metaTitle.textContent = "Conectar Página do LinkedIn";
                metaLabel.textContent = "Selecione a página";

                metaModal.show();

                try {
                    const resp = await fetch(`/api/linkedin/organizations?id_customer=${encodeURIComponent(id_customer)}`);
                    const data = await resp.json();

                    if (!resp.ok || !data.success) throw new Error(data.message || "Erro ao listar páginas LinkedIn");

                    if (!data.organizations || !data.organizations.length) {
                        metaSelect.innerHTML =
                            `<option value="">Nenhuma página encontrada</option>`;
                        setMetaLoading(false, "Conectar");
                        return;
                    }

                    metaSelect.innerHTML = data.organizations.map(org => `
                    <option
                        value="${org.id}"
                        data-name="${org.name.replace(/"/g, "&quot;")}"
                    >
                        ${org.name}
                    </option>
                    `).join("");

                    setMetaLoading(false, "Conectar");

                    metaSaveBtn.onclick = async () => {
                        const opt = metaSelect.options[metaSelect.selectedIndex];
                        const resource_id = opt?.value;
                        const resource_name = opt?.dataset?.name;

                        if (!resource_id) {
                            showMetaError("Selecione uma página válida.");
                            return;
                        }

                        try {
                            setMetaLoading(true, "Conectando...");

                            const r = await fetch("/api/linkedin/connect", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    id_customer,
                                    resource_id,
                                    resource_name
                                })
                            });

                            const j = await r.json();
                            if (!r.ok || !j.success) throw new Error(j.message || "Erro ao conectar LinkedIn");

                            metaModal.hide();
                            window.location.href = `/myCustomersPage.html?open=${encodeURIComponent(id_customer)}`;
                        } catch (err) {
                            showMetaError(err.message || "Erro ao conectar.");
                        } finally {
                            setMetaLoading(false, "Conectar");
                        }
                    };
                } catch (err) {
                    showMetaError(err.message || "Erro ao carregar páginas.");
                    setMetaLoading(false, "Conectar");
                }
            }

            async function openGaPropertyModal(id_customer) {
                if (!metaModal) return;

                showMetaError("");
                metaSelect.innerHTML = "";
                setMetaLoading(true, "Carregando...");

                metaTitle.textContent = "Conectar Property do Google Analytics";
                metaLabel.textContent = "Selecione a property";

                metaModal.show();

                try {
                    const resp = await fetch(`/api/googleAnalytics/properties?id_customer=${encodeURIComponent(id_customer)}`);
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data.message || "Erro ao listar properties");

                    if (!data.properties || !data.properties.length) {
                        metaSelect.innerHTML = `<option value="">Nenhuma property encontrada</option>`;
                        setMetaLoading(false, "Conectar");
                        return;
                    }

                    metaSelect.innerHTML = data.properties.map(p => `
                    <option value="${p.id_property}" data-name="${(p.displayName || "").replace(/"/g, "&quot;")}">
                        ${p.displayName} (ID: ${p.propertyIdNumber})
                    </option>
                    `).join("");

                    setMetaLoading(false, "Conectar");

                    metaSaveBtn.onclick = async () => {
                        const opt = metaSelect.options[metaSelect.selectedIndex];
                        const resource_id = opt?.value;
                        const resource_name = opt?.dataset?.name || opt?.textContent || null;

                        if (!resource_id) { showMetaError("Selecione uma property válida."); return; }

                        try {
                            setMetaLoading(true, "Conectando...");

                            const r = await fetch("/api/googleAnalytics/connect", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ id_customer, resource_id, resource_name })
                            });

                            const j = await r.json();
                            if (!r.ok || !j.success) throw new Error(j.message || "Erro ao conectar GA");

                            metaModal.hide();
                            window.location.href = `/myCustomersPage.html?open=${encodeURIComponent(id_customer)}`;
                        } catch (err) {
                            showMetaError(err.message || "Erro ao conectar.");
                        } finally {
                            setMetaLoading(false, "Conectar");
                        }
                    };
                } catch (err) {
                    showMetaError(err.message || "Erro ao carregar properties.");
                    setMetaLoading(false, "Conectar");
                }
            }

            async function openYoutubeChannelModal(id_customer) {
                if (!metaModal) return;

                showMetaError("");
                metaSelect.innerHTML = "";
                setMetaLoading(true, "Carregando...");

                metaTitle.textContent = "Conectar Canal do YouTube";
                metaLabel.textContent = "Selecione o canal";

                metaModal.show();

                try {
                    const resp = await fetch(`/api/youtube/channels?id_customer=${encodeURIComponent(id_customer)}`);
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data.message || "Erro ao listar canais");

                    if (!data.channels || !data.channels.length) {
                        metaSelect.innerHTML = `<option value="">Nenhum canal encontrado</option>`;
                        setMetaLoading(false, "Conectar");
                        return;
                    }

                    metaSelect.innerHTML = data.channels.map(c => `
                    <option value="${c.id_channel}" data-name="${(c.title || "").replace(/"/g, "&quot;")}">
                        ${c.title || c.id_channel}
                    </option>
                    `).join("");

                    setMetaLoading(false, "Conectar");

                    metaSaveBtn.onclick = async () => {
                        const opt = metaSelect.options[metaSelect.selectedIndex];
                        const resource_id = opt?.value;
                        const resource_name = opt?.dataset?.name || opt?.textContent || null;

                        if (!resource_id) { showMetaError("Selecione um canal válido."); return; }

                        try {
                            setMetaLoading(true, "Conectando...");

                            const r = await fetch("/api/youtube/connect", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ id_customer, resource_id, resource_name })
                            });

                            const j = await r.json();
                            if (!r.ok || !j.success) throw new Error(j.message || "Erro ao conectar YouTube");

                            metaModal.hide();
                            window.location.href = `/myCustomersPage.html?open=${encodeURIComponent(id_customer)}`;
                        } catch (err) {
                            showMetaError(err.message || "Erro ao conectar.");
                        } finally {
                            setMetaLoading(false, "Conectar");
                        }
                    };
                } catch (err) {
                    showMetaError(err.message || "Erro ao carregar canais.");
                    setMetaLoading(false, "Conectar");
                }
            }

            // Click handlers (event delegation)
            const removePlatformModalEl = document.getElementById("removePlatformModal");
            const removePlatformModal = removePlatformModalEl ? new bootstrap.Modal(removePlatformModalEl) : null;
            const removePlatformCustomerId = document.getElementById("removePlatformCustomerId");
            const removePlatformName = document.getElementById("removePlatformName");
            const removePlatformConfirmBtn = document.getElementById("removePlatformConfirmBtn");

            removePlatformConfirmBtn?.addEventListener("click", async () => {
                const id_customer = removePlatformCustomerId?.value;
                const platform = removePlatformName?.value;
                if (!id_customer || !platform) return;

                removePlatformConfirmBtn.disabled = true;

                try {
                    const resp = await fetch(`/customer/remove/${encodeURIComponent(id_customer)}/${encodeURIComponent(platform)}`, { method: "DELETE" });
                    const data = await resp.json();

                    if (!resp.ok || !data.success) throw new Error(data.message || "Erro ao remover plataforma.");

                    if (removePlatformModal) removePlatformModal.hide();

                    window.location.href = `/myCustomersPage.html?open=${encodeURIComponent(id_customer)}`;
                } catch (e) {
                    alert(e.message || "Erro ao remover plataforma.");
                } finally {
                    removePlatformConfirmBtn.disabled = false;
                }
            });

            document.addEventListener("click", (e) => {
                const gaAuthBtn = e.target.closest(".js-ga-authorize");
                const linkedinAuthBtn = e.target.closest(".js-linkedin-authorize");
                const metaAuthBtn = e.target.closest(".js-meta-authorize");
                const ytAuthBtn = e.target.closest(".js-yt-authorize");

                if (gaAuthBtn) {
                    const id_customer = gaAuthBtn.dataset.customer;
                    if (!id_customer) return;
                    window.location.href = `/api/googleAnalytics/auth?id_customer=${encodeURIComponent(id_customer)}`;
                    return;
                }
                if (linkedinAuthBtn) {
                    const id_customer = linkedinAuthBtn.dataset.customer;
                    if (!id_customer) return;
                    window.location.href = `/api/linkedin/auth?id_customer=${encodeURIComponent(id_customer)}`;
                    return;
                }
                if (metaAuthBtn) {
                    const id_customer = metaAuthBtn.dataset.customer;
                    if (!id_customer) return;
                    window.location.href = `/api/meta/auth?id_customer=${encodeURIComponent(id_customer)}`;
                    return;
                }
                if (ytAuthBtn) {
                    const id_customer = ytAuthBtn.dataset.customer;
                    if (!id_customer) return;
                    window.location.href = `/api/youtube/auth?id_customer=${encodeURIComponent(id_customer)}`;
                    return;
                }

                const gaRenewBtn = e.target.closest(".js-ga-renew");
                if (gaRenewBtn) {
                    const id_customer = gaRenewBtn.dataset.customer;
                    if (!id_customer) return;
                    window.location.href = `/api/googleAnalytics/auth?id_customer=${encodeURIComponent(id_customer)}`;
                    return;
                }
                const ytRenewBtn = e.target.closest(".js-yt-renew");
                if (ytRenewBtn) {
                    const id_customer = ytRenewBtn.dataset.customer;
                    if (!id_customer) return;
                    window.location.href = `/api/youtube/auth?id_customer=${encodeURIComponent(id_customer)}`;
                    return;
                }

                const gaSelectBtn = e.target.closest(".js-ga-select");
                if (gaSelectBtn) {
                    const id_customer = gaSelectBtn.dataset.customer;
                    if (!id_customer) return;
                    openGaPropertyModal(id_customer);
                    return;
                }
                const linkedinSelectBtn = e.target.closest(".js-linkedin-select");
                if (linkedinSelectBtn) {
                    const id_customer = linkedinSelectBtn.dataset.customer;
                    if (!id_customer) return;

                    openLinkedinOrganizationModal(id_customer);
                    return;
                }
                const metaSelectBtn = e.target.closest(".js-meta-select");
                if (metaSelectBtn) {
                    const id_customer = metaSelectBtn.dataset.customer;
                    const platform = metaSelectBtn.dataset.platform;
                    if (!id_customer || !platform) return;
                    openMetaResourceModal(id_customer, platform);
                }
                const ytSelectBtn = e.target.closest(".js-yt-select");
                if (ytSelectBtn) {
                    const id_customer = ytSelectBtn.dataset.customer;
                    if (!id_customer) return;
                    openYoutubeChannelModal(id_customer);
                    return;
                }

                const removeBtn = e.target.closest(".js-platform-remove");
                if (removeBtn) {
                    const id_customer = removeBtn.dataset.customer;
                    const platform = removeBtn.dataset.platform;
                    if (!id_customer || !platform) return;

                    if (removePlatformCustomerId) removePlatformCustomerId.value = id_customer;
                    if (removePlatformName) removePlatformName.value = platform;

                    if (removePlatformModal) removePlatformModal.show();
                    return;
                }


            });

            async function loadCustomers() {
                const resp = await fetch("/customer/list");
                const data = await resp.json();
                const customers = data.customers || [];

                tbody.innerHTML = "";

                if (!customers.length) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">Nenhum cliente encontrado</td></tr>`;
                    return;
                }

                customers.forEach(c => {
                    const node = document.importNode(tpl.content, true);

                    const customerNameEl = node.querySelector("tr:first-child .fw-medium");
                    if (customerNameEl) customerNameEl.textContent = safeText(c.name);

                    const tds = node.querySelectorAll("tr:first-child td");
                    if (tds[1]) tds[1].innerHTML = safeText(c.phone);
                    if (tds[2]) tds[2].innerHTML = safeText(c.email);

                    const status = (c.status || "active").toLowerCase();
                    const isInactive = status === "inactive";

                    // ícones das plataformas (só para ativos faz diferença visual, mas deixei igual)
                    const iconsWrap = node.querySelector("tr:first-child td:nth-child(4) .d-inline-flex");
                    if (iconsWrap) iconsWrap.innerHTML = renderPlatformIcons(c.integrations);

                    const hasConnected = (c.integrations || []).some(
                        i => (i.status || "").toLowerCase() === "connected"
                    );

                    // Coluna STATUS
                    if (tds[4]) {
                        if (isInactive) {
                            tds[4].innerHTML = '<span class="badge bg-label-secondary me-1">Desativado</span>';
                        } else {
                            tds[4].innerHTML = badgeStatus(hasConnected);
                        }
                    }

                    // define ids do acordeão / botão expandir
                    const btnExpand = node.querySelector(".customer-expand");
                    const collapseEl = node.querySelector(".customer-details-row .collapse");
                    const detailsCol = node.querySelector(".customer-details-col");
                    const details = node.querySelector(".customer-platforms-container");

                    if (isInactive) {
                        // desativa o botão de expandir e não configura o accordion
                        if (btnExpand) {
                            btnExpand.disabled = true;
                            btnExpand.classList.add("disabled");
                            btnExpand.removeAttribute("data-bs-toggle");
                            btnExpand.removeAttribute("data-bs-target");
                            btnExpand.setAttribute("title", "Cliente desativado");
                        }
                        // se quiser esconder totalmente o detalhe, descomenta a linha abaixo:
                        // const rowDetails = node.querySelector(".customer-details-row"); if (rowDetails) rowDetails.remove();
                    } else {
                        if (btnExpand && collapseEl && c.id_customer) {
                            const collapseId = `customerPlatforms-${c.id_customer}`;

                            collapseEl.id = collapseId;

                            btnExpand.setAttribute("data-bs-target", `#${collapseId}`);
                            btnExpand.setAttribute("aria-controls", collapseId);
                        }
                        if (detailsCol) detailsCol.id = `customerPlatforms-${c.id_customer}-col`;
                        if (details) details.innerHTML = renderIntegrationsPanel(c);
                    }

                    // Coluna AÇÕES
                    const actionsTd = tds[5];
                    if (isInactive) {
                        if (actionsTd) {
                            actionsTd.innerHTML = '<span class="text-muted small">Cliente desativado</span>';
                        }
                    } else {
                        // seta ids no botão editar já existente
                        const editBtn = node.querySelector(".edit_client");
                        if (editBtn && c.id_customer) editBtn.dataset.id = c.id_customer;

                        // seta ids no botão remover já existente
                        const removeBtn = node.querySelector(".remove-client");
                        if (removeBtn && c.id_customer) removeBtn.dataset.id = c.id_customer;
                    }

                    tbody.appendChild(node);
                });

                // abre automaticamente o accordion se veio do callback (?open=...)
                const openId = new URLSearchParams(window.location.search).get("open");
                if (openId) {
                    const collapseEl = document.getElementById(`customerPlatforms-${openId}`);
                    if (collapseEl) bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false }).show();
                }
            }

            loadCustomers().catch(() => {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Erro ao carregar clientes</td></tr>`;
            });
        });
    </script>
    <!-- myCustomersEditCustomer.js -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const modalEl = document.getElementById("modalEditClient");
            if (!modalEl) return;

            const modal = new bootstrap.Modal(modalEl);

            const idEl = document.getElementById("editClientId");
            const nameEl = document.getElementById("editClientName");
            const companyEl = document.getElementById("editClientCompany");
            const emailEl = document.getElementById("editClientEmail");
            const phoneEl = document.getElementById("editClientPhone");

            const btn = document.getElementById("confirmEditClient");
            const spinner = document.getElementById("editCustomerSpinner");
            const btnText = btn ? btn.querySelector(".btn-text") : null;

            const alertContainer = document.getElementById("alert-container");

            function showAlert(type, message) {
                if (!alertContainer) return;
                alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>
                `;
            }

            function setLoading(isLoading) {
                if (!btn) return;
                btn.disabled = isLoading;
                if (spinner) spinner.classList.toggle("d-none", !isLoading);
                if (btnText) btnText.textContent = isLoading ? "Salvando..." : "Confirmar Modificação";
            }

            let original = null;

            // Abrir modal ao clicar em Editar
            document.addEventListener("click", async (event) => {
                const edit = event.target.closest(".edit_client");
                if (!edit) return;

                event.preventDefault();
                const id_customer = edit.dataset.id;
                if (!id_customer) return;

                try {
                    const resp = await fetch(`/customer/get/${id_customer}`);
                    const data = await resp.json();

                    if (!resp.ok || !data.success || !data.customer?.length) {
                        throw new Error(data.message || "Erro ao carregar cliente.");
                    }

                    const c = data.customer[0];
                    original = {
                        id_customer,
                        name: c.name || "",
                        company: c.company || "",
                        email: c.email || "",
                        phone: c.phone || ""
                    };

                    idEl.value = id_customer;
                    nameEl.value = original.name;
                    companyEl.value = original.company;
                    emailEl.value = original.email;
                    phoneEl.value = original.phone;

                    modal.show();
                } catch (err) {
                    showAlert("danger", err.message || "Erro ao carregar cliente.");
                }
            });

            // Confirmar edição
            btn?.addEventListener("click", async () => {
                const id_customer = idEl.value;
                const payload = {
                    name: nameEl.value.trim(),
                    company: companyEl.value.trim() || null,
                    email: emailEl.value.trim(),
                    phone: phoneEl.value.trim() || null
                };

                if (!payload.name || !payload.email) {
                    showAlert("danger", "Nome e email são obrigatórios.");
                    return;
                }

                // Se não mudou nada
                if (
                    original &&
                    payload.name === original.name &&
                    (payload.company || "") === (original.company || "") &&
                    payload.email === original.email &&
                    (payload.phone || "") === (original.phone || "")
                ) {
                    modal.hide();
                    showAlert("info", "Nenhuma alteração foi detectada.");
                    return;
                }

                setLoading(true);

                try {
                    const resp = await fetch(`/customer/edit/${id_customer}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await resp.json();

                    if (!resp.ok || !data.success) {
                        throw new Error(data.message || "Erro ao atualizar cliente.");
                    }

                    modal.hide();
                    showAlert("success", "Cliente atualizado com sucesso!");
                    setTimeout(() => location.reload(), 400);
                } catch (err) {
                    showAlert("danger", err.message || "Erro ao atualizar cliente.");
                } finally {
                    setLoading(false);
                }
            });
        });
    </script>
    <!-- Remover cliente -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const modalEl = document.getElementById("deleteCustomerModal");
            const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

            const idEl = document.getElementById("delete_id_customer");
            const btn = document.getElementById("confirmDeleteCustomerBtn");
            const btnText = document.getElementById("deleteCustomerBtnText");
            const spinner = document.getElementById("deleteCustomerSpinner");
            const alertBox = document.getElementById("deleteCustomerAlert");

            let rowMain = null;
            let rowDetails = null;

            const setLoading = (loading) => {
                if (!btn) return;
                btn.disabled = loading;
                if (spinner) spinner.classList.toggle("d-none", !loading);
                if (btnText) btnText.textContent = loading ? "Desativando..." : "Desativar";
            };

            const showAlert = (type, msg) => {
                if (!alertBox) return;
                alertBox.innerHTML = `<div class="alert alert-${type} mb-0" role="alert">${msg}</div>`;
            };

            document.addEventListener("click", (e) => {
                const a = e.target.closest(".remove-client");
                if (!a) return;

                e.preventDefault();

                const id_customer = a.dataset.id;
                if (!id_customer) return;

                rowMain = a.closest("tr");
                rowDetails = rowMain ? rowMain.nextElementSibling : null;

                if (idEl) idEl.value = id_customer;
                if (alertBox) alertBox.innerHTML = "";

                modal?.show();
            });

            btn?.addEventListener("click", async () => {
                const id_customer = idEl?.value;
                if (!id_customer) return;

                setLoading(true);

                try {
                    const resp = await fetch(`/customer/delete/${id_customer}`, { method: "DELETE" });
                    const data = await resp.json();

                    if (!resp.ok || !data.success) throw new Error(data.message || "Erro ao desativar cliente.");

                    modal?.hide();

                    // recarrega para mostrar o cliente como "Desativado" e travar ações
                    window.location.reload();
                } catch (err) {
                    showAlert("danger", err.message || "Erro ao desativar cliente.");
                } finally {
                    setLoading(false);
                }
            });
        });
    </script>
</body>

</html>