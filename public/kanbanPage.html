<!DOCTYPE html>

<html lang="en" class="light-style layout-menu-fixed layout-compact layout-menu-collapsed" dir="ltr"
    data-theme="theme-default" data-assets-path="/assets/" data-template="vertical-menu-template-free">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Kanban - Analytics </title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon/favicon.ico" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet" />

    <!-- Jeferson: Icones -->
    <link rel="stylesheet" href="/assets/vendor/fonts/boxicons.css" />

    <!-- Jeferson: Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Jeferson: Tema opcional para Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

    <!-- Core CSS -->
    <link rel="stylesheet" href="/assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="/assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="/assets/vendor/libs/apex-charts/apex-charts.css" />

    <!-- Helpers -->
    <script src="/assets/vendor/js/helpers.js"></script>
    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="/assets/js/config.js"></script>

    <!-- ADICIONE este bloco como módulo -->
    <script type="module">
        import * as pdfjs from "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.mjs";
        // o worker também é módulo na v4
        pdfjs.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.mjs";

        // expõe no global para o resto do seu código que usa pdfjsLib
        window.pdfjsLib = pdfjs;
    </script>

    <!--barra colapse-->
    <style>
        /* ho.ko fix — manter layout correto quando menu estiver colapsado */
        @media (min-width: 1200px) {

            /* Quando estiver colapsado, a página precisa continuar “respeitando” 5.25rem */
            html.layout-menu-fixed.layout-menu-collapsed .layout-page,
            html.layout-menu-fixed-offcanvas.layout-menu-collapsed .layout-page {
                padding-left: 5.25rem;
            }

            /* Navbar fixa também precisa acompanhar */
            html.layout-navbar-fixed.layout-menu-collapsed .layout-content-navbar:not(.layout-without-menu) .layout-navbar,
            html.layout-menu-fixed.layout-navbar-fixed.layout-menu-collapsed .layout-content-navbar:not(.layout-without-menu) .layout-navbar,
            html.layout-menu-fixed-offcanvas.layout-navbar-fixed.layout-menu-collapsed .layout-content-navbar:not(.layout-without-menu) .layout-navbar {
                left: 5.25rem;
            }

            /* Footer fixo também */
            html.layout-footer-fixed.layout-menu-collapsed .layout-wrapper:not(.layout-without-menu) .content-footer {
                left: 5.25rem;
            }
        }
    </style>
</head>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">

            <!-- Menu -->
            <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
                <div class="app-brand demo">
                    <a href="javascript:void(0);" class="app-brand-link">
                        <div class="avatar">
                            <img src="/assets/img/favicon/favicon.ico" alt class="w-px-40 h-auto rounded-circle" />
                        </div>
                    </a>

                    <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
                        <i class="bx bx-chevron-left bx-sm align-middle"></i>
                    </a>

                </div>

                <div class="menu-inner-shadow"></div>

                <ul class="menu-inner py-1">

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Páginas</span>
                    </li>
                    <!-- Apps -->
                    <li class="menu-item">
                        <a href="/dashboardPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bx bx-layout"></i>
                            <div data-i18n="Email">Dashboard</div>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="/analyzesPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-robot"></i>
                            <div data-i18n="Calendar">Análises</div>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="/chatPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bx bx-chat"></i>
                            <div data-i18n="Chat">Chat</div>
                        </a>
                    </li>

                    <li class="menu-item active">
                        <a href="/foodModelPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-menu-up"></i>
                            <div data-i18n="Chat">Kanban</div>
                        </a>
                    </li>

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Plataformas & Clientes</span>
                    </li>

                    <li class="menu-item">
                        <a href="/platformsPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-link-45deg"></i>
                            <div data-i18n="Chat">Plataformas</div>
                        </a>
                    </li>

                    <!-- Layouts -->
                    <li class="menu-item">
                        <a href="javascript:void(0);" class="menu-link menu-toggle">
                            <i class="menu-icon tf-icons bi bi-people"></i>
                            <div data-i18n="Chat">Clientes</div>
                        </a>

                        <ul class="menu-sub">
                            <li class="menu-item">
                                <a href="myCustomersPage.html" class="menu-link">
                                    <div data-i18n="Without menu">Meus Clientes</div>
                                </a>
                            </li>
                            <li class="menu-item">
                                <a href="customersPage.html" class="menu-link">
                                    <div data-i18n="Without navbar">Adicionar Clientes</div>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Outros</span>
                    </li>

                    <li class="menu-item">
                        <a href="javascript:void(0);" class="menu-link menu-toggle">
                            <i class="menu-icon tf-icons bi bi-gear"></i>
                            <div data-i18n="Chat">Configurações</div>
                        </a>

                        <ul class="menu-sub">
                            <li class="menu-item">
                                <a href="/settingsAccountPage.html" class="menu-link">
                                    <div data-i18n="Without menu">Conta</div>
                                </a>
                            </li>
                            <!--<li class="menu-item">
                                <a href="/notificationsPage.html" class="menu-link">
                                    <div data-i18n="Without navbar">Notificações</div>
                                </a>
                            </li>-->
                        </ul>
                    </li>

                    <li class="menu-item">
                        <a href="#" class="menu-link" data-bs-toggle="modal" data-bs-target="#contactModal">
                            <i class="menu-icon tf-icons bi bi-headset"></i>
                            <div data-i18n="Chat">Fale conosco</div>
                        </a>
                    </li>

                    <li class="menu-header small text-uppercase">
                        <span class="menu-header-text">Segurança</span>
                    </li>

                    <li class="menu-item">
                        <a href="/termsUse.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-file-earmark-lock"></i>
                            <div data-i18n="Chat">Termos de Uso</div>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="/privacyPolicyPage.html" class="menu-link">
                            <i class="menu-icon tf-icons bi bi-shield-lock"></i>
                            <div data-i18n="Chat">Política de Privacidade</div>
                        </a>
                    </li>

                </ul>
            </aside>
            <!-- / Menu -->

            <!-- Layout container -->
            <div class="layout-page">

                <!-- Navbar -->
                <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
                    id="layout-navbar">
                    <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
                        <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
                            <i class="bx bx-menu bx-sm"></i>
                        </a>
                    </div>

                    <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">

                        <ul class="navbar-nav flex-row align-items-center ms-auto">
                            <li class="nav-item lh-1 me-3">
                                <div class="dropdown">
                                    <button
                                        class="btn border d-flex align-items-center justify-content-between w-100 py-2"
                                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd"
                                                d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />
                                        </svg>
                                        <span id="selected-customer-name" class="mx-3">Cliente</span>
                                    </button>
                                    <ul class="dropdown-menu w-100" id="dropdown-customer-list">
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li><a class="dropdown-item" href="#">Adicionar cliente</a></li>
                                    </ul>
                                </div>
                            </li>

                            <!-- User -->
                            <li class="nav-item navbar-dropdown dropdown-user dropdown">
                                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);"
                                    data-bs-toggle="dropdown">
                                    <div class="avatar avatar-online">
                                        <img src="/assets/img/favicon/favicon.ico" alt
                                            class="w-px-40 h-auto rounded-circle user-profile-avatar" />
                                    </div>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="#">
                                            <div class="d-flex">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="avatar avatar-online">
                                                        <img src="/assets/img/favicon/favicon.ico" alt
                                                            class="w-px-40 h-auto rounded-circle user-profile-avatar" />
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <span class="fw-medium d-block" id="user-name"></span>
                                                    <small class="text-muted">Admin</small>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    <li>
                                        <div class="dropdown-divider"></div>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="/settingsAccountPage.html">
                                            <i class="bx bx-user me-2"></i>
                                            <span class="align-middle">Perfil</span>
                                        </a>
                                    </li>
                                    <!--<li>
                                        <a class="dropdown-item" href="#">
                                            <span class="d-flex align-items-center align-middle">
                                                <i class="flex-shrink-0 bx bx-credit-card me-2"></i>
                                                <span class="flex-grow-1 align-middle ms-1">Billing</span>
                                                <span
                                                    class="flex-shrink-0 badge badge-center rounded-pill bg-danger w-px-20 h-px-20">4</span>
                                            </span>
                                        </a>
                                    </li>-->
                                    <li>
                                        <div class="dropdown-divider"></div>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="javascript:void(0);" id="log-out">
                                            <i class="bx bx-power-off me-2"></i>
                                            <span class="align-middle">Sair</span>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                            <!--/ User -->
                        </ul>
                    </div>
                </nav>

                <div class="container-xxl pt-4">
                    <div id="feedback-message" class="alert" style="display: none; margin-top: 10px;"></div>
                    <div class="row">
                        <div class="col-xxl">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <!-- Header -->
                                    <!-- Kanban + Metas (mock) -->
                                    <div id="kanban-feedback" class="alert" style="display:none;"></div>

                                    <ul class="nav nav-pills mb-3" id="kanbanTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="tab-kanban" data-bs-toggle="pill"
                                                data-bs-target="#pane-kanban" type="button" role="tab"
                                                aria-controls="pane-kanban" aria-selected="true">
                                                <i class="bx bx-columns me-1"></i> Kanban
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="tab-metas" data-bs-toggle="pill"
                                                data-bs-target="#pane-metas" type="button" role="tab"
                                                aria-controls="pane-metas" aria-selected="false">
                                                <i class="bx bx-target-lock me-1"></i> Metas & Objetivos
                                            </button>
                                        </li>
                                    </ul>

                                    <div class="tab-content" id="kanbanTabsContent">

                                        <!-- =================== KANBAN =================== -->
                                        <div class="tab-pane fade show active" id="pane-kanban" role="tabpanel"
                                            aria-labelledby="tab-kanban" tabindex="0">

                                            <!-- Toolbar -->
                                            <div class="row g-3 align-items-end mb-3">
                                                <div class="col-12 col-md-4 col-xxl-4">
                                                    <label class="form-label">Buscar</label>
                                                    <div class="input-group input-group-merge">
                                                        <span class="input-group-text"><i
                                                                class="bx bx-search"></i></span>
                                                        <input id="kb-search" type="text" class="form-control"
                                                            placeholder="Título, cliente, tag..." />
                                                    </div>
                                                </div>

                                                <div class="col-6 col-md-2 col-xxl-2">
                                                    <label class="form-label">Cliente</label>
                                                    <select id="kb-filter-client" class="form-select">
                                                        <option value="all">Todos</option>
                                                    </select>
                                                </div>

                                                <div class="col-6 col-md-2 col-xxl-2">
                                                    <label class="form-label">Responsável</label>
                                                    <select id="kb-filter-member" class="form-select">
                                                        <option value="all">Todos</option>
                                                    </select>
                                                </div>

                                                <div class="col-6 col-md-2 col-xxl-2">
                                                    <label class="form-label">Prioridade</label>
                                                    <select id="kb-filter-priority" class="form-select">
                                                        <option value="all">Todas</option>
                                                        <option value="P0">P0</option>
                                                        <option value="P1">P1</option>
                                                        <option value="P2">P2</option>
                                                        <option value="P3">P3</option>
                                                    </select>
                                                </div>

                                                <div class="col-6 col-md-2 col-xxl-2 text-md-end">
                                                    <button class="btn btn-primary w-100" id="kb-open-create">
                                                        <i class="bx bx-plus me-1"></i> Novo card
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Quick metrics (mantive como você curtiu) -->
                                            <div class="row g-3 mb-3" id="kb-summary-cards">
                                                <div class="col-12 col-md-3">
                                                    <div class="card border">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between">
                                                                <div>
                                                                    <div class="text-muted small">WIP (em andamento)
                                                                    </div>
                                                                    <div class="h4 mb-0" id="sum-wip">0</div>
                                                                </div>
                                                                <div class="avatar">
                                                                    <span
                                                                        class="avatar-initial rounded bg-label-primary"><i
                                                                            class="bx bx-loader-circle"></i></span>
                                                                </div>
                                                            </div>
                                                            <div class="small mt-2 text-muted">Cards em execução agora
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-12 col-md-3">
                                                    <div class="card border">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between">
                                                                <div>
                                                                    <div class="text-muted small">On-time</div>
                                                                    <div class="h4 mb-0" id="sum-ontime">0%</div>
                                                                </div>
                                                                <div class="avatar">
                                                                    <span
                                                                        class="avatar-initial rounded bg-label-success"><i
                                                                            class="bx bx-timer"></i></span>
                                                                </div>
                                                            </div>
                                                            <div class="small mt-2 text-muted">Entregas no prazo</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-12 col-md-3">
                                                    <div class="card border">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between">
                                                                <div>
                                                                    <div class="text-muted small">Qualidade</div>
                                                                    <div class="h4 mb-0" id="sum-quality">0</div>
                                                                </div>
                                                                <div class="avatar">
                                                                    <span
                                                                        class="avatar-initial rounded bg-label-warning"><i
                                                                            class="bx bx-shield-quarter"></i></span>
                                                                </div>
                                                            </div>
                                                            <div class="small mt-2 text-muted">Score médio (0–100)</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-12 col-md-3">
                                                    <div class="card border">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between">
                                                                <div>
                                                                    <div class="text-muted small">Retrabalho</div>
                                                                    <div class="h4 mb-0" id="sum-rework">0</div>
                                                                </div>
                                                                <div class="avatar">
                                                                    <span
                                                                        class="avatar-initial rounded bg-label-danger"><i
                                                                            class="bx bx-revision"></i></span>
                                                                </div>
                                                            </div>
                                                            <div class="small mt-2 text-muted">Alterações solicitadas
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Board (agora ocupa mais e não fica espremido) -->
                                            <div id="kb-board-scroll" class="kb-board-scroll">
                                                <div id="kb-board" class="kb-board">


                                                    <div class="kb-col">
                                                        <div class="card border kb-col-card">
                                                            <div
                                                                class="card-header d-flex align-items-center justify-content-between py-3">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <span class="badge bg-label-secondary"><i
                                                                            class="bx bi-box"></i></span>
                                                                    <div class="fw-medium">Backlog</div>
                                                                    <span class="text-muted"
                                                                        id="count-backlog">(0)</span>
                                                                </div>
                                                                <small class="text-muted">Briefing</small>
                                                            </div>
                                                            <div class="card-body pt-2">
                                                                <div class="kb-dropzone" data-status="backlog"></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="kb-col">
                                                        <div class="card border kb-col-card">
                                                            <div
                                                                class="card-header d-flex align-items-center justify-content-between py-3">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <span class="badge bg-label-primary"><i
                                                                            class="bx bx-loader-circle"></i></span>
                                                                    <div class="fw-medium">Em andamento</div>
                                                                    <span class="text-muted" id="count-doing">(0)</span>
                                                                </div>
                                                                <small class="text-muted">Produção</small>
                                                            </div>
                                                            <div class="card-body pt-2">
                                                                <div class="kb-dropzone" data-status="doing"></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="kb-col">
                                                        <div class="card border kb-col-card">
                                                            <div
                                                                class="card-header d-flex align-items-center justify-content-between py-3">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <span class="badge bg-label-warning"><i
                                                                            class="bx bx-check-shield"></i></span>
                                                                    <div class="fw-medium">Em aprovação</div>
                                                                    <span class="text-muted"
                                                                        id="count-approval">(0)</span>
                                                                </div>
                                                                <small class="text-muted">Cliente</small>
                                                            </div>
                                                            <div class="card-body pt-2">
                                                                <div class="kb-dropzone" data-status="approval"></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="kb-col">
                                                        <div class="card border kb-col-card">
                                                            <div
                                                                class="card-header d-flex align-items-center justify-content-between py-3">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <span class="badge bg-label-danger"><i
                                                                            class="bx bx-revision"></i></span>
                                                                    <div class="fw-medium">Alteração necessária</div>
                                                                    <span class="text-muted"
                                                                        id="count-changes">(0)</span>
                                                                </div>
                                                                <small class="text-muted">Retrabalho</small>
                                                            </div>
                                                            <div class="card-body pt-2">
                                                                <div class="kb-dropzone" data-status="changes"></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="kb-col">
                                                        <div class="card border kb-col-card">
                                                            <div
                                                                class="card-header d-flex align-items-center justify-content-between py-3">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <span class="badge bg-label-success"><i
                                                                            class="bx bx-check-double"></i></span>
                                                                    <div class="fw-medium">Aprovados</div>
                                                                    <span class="text-muted"
                                                                        id="count-approved">(0)</span>
                                                                </div>
                                                                <small class="text-muted">Pronto</small>
                                                            </div>
                                                            <div class="card-body pt-2">
                                                                <div class="kb-dropzone" data-status="approved"></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="kb-col">
                                                        <div class="card border kb-col-card">
                                                            <div
                                                                class="card-header d-flex align-items-center justify-content-between py-3">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <span class="badge bg-label-info"><i
                                                                            class="bx bx-calendar-check"></i></span>
                                                                    <div class="fw-medium">Agendados</div>
                                                                    <span class="text-muted"
                                                                        id="count-scheduled">(0)</span>
                                                                </div>
                                                                <small class="text-muted">Agendamento</small>
                                                            </div>
                                                            <div class="card-body pt-2">
                                                                <div class="kb-dropzone" data-status="scheduled"></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="kb-col">
                                                        <div class="card border kb-col-card">
                                                            <div
                                                                class="card-header d-flex align-items-center justify-content-between py-3">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <span class="badge bg-label-dark"><i
                                                                            class="bx bx-world"></i></span>
                                                                    <div class="fw-medium">Publicados</div>
                                                                    <span class="text-muted"
                                                                        id="count-published">(0)</span>
                                                                </div>
                                                                <small class="text-muted">Final</small>
                                                            </div>
                                                            <div class="card-body pt-2">
                                                                <div class="kb-dropzone" data-status="published"></div>
                                                            </div>
                                                        </div>
                                                    </div>


                                                </div>

                                            </div>
                                        </div>

                                    </div>

                                    <!-- =================== METAS =================== -->
                                    <div class="tab-pane fade" id="pane-metas" role="tabpanel"
                                        aria-labelledby="tab-metas" tabindex="0">

                                        <div class="row g-3">
                                            <div class="col-12 col-xl-4">
                                                <div class="card border">
                                                    <div class="card-header">
                                                        <h5 class="mb-0"><i class="bx bx-bar-chart-alt-2 me-2"></i>Visão
                                                            do time
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between">
                                                                <span class="text-muted">Entregas no prazo
                                                                    (meta)</span>
                                                                <span class="fw-medium" id="goal-team-ontime">0% /
                                                                    90%</span>
                                                            </div>
                                                            <div class="progress mt-2" style="height: 10px;">
                                                                <div id="bar-team-ontime" class="progress-bar"
                                                                    role="progressbar" style="width: 0%"></div>
                                                            </div>
                                                        </div>

                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between">
                                                                <span class="text-muted">Qualidade média
                                                                    (meta)</span>
                                                                <span class="fw-medium" id="goal-team-quality">0 /
                                                                    85</span>
                                                            </div>
                                                            <div class="progress mt-2" style="height: 10px;">
                                                                <div id="bar-team-quality" class="progress-bar"
                                                                    role="progressbar" style="width: 0%"></div>
                                                            </div>
                                                        </div>

                                                        <div class="mb-0">
                                                            <div class="d-flex justify-content-between">
                                                                <span class="text-muted">Retrabalho (meta
                                                                    máx.)</span>
                                                                <span class="fw-medium" id="goal-team-rework">0 /
                                                                    10</span>
                                                            </div>
                                                            <div class="progress mt-2" style="height: 10px;">
                                                                <div id="bar-team-rework" class="progress-bar"
                                                                    role="progressbar" style="width: 0%"></div>
                                                            </div>
                                                        </div>

                                                        <hr />

                                                        <div class="small text-muted">
                                                            * “Qualidade” (mock) = 100 - retrabalho - atraso.
                                                        </div>

                                                        <hr class="my-3" />

                                                        <div
                                                            class="d-flex justify-content-between align-items-center mb-2">
                                                            <div class="fw-semibold">Resultados por cliente</div>
                                                            <button class="btn btn-sm btn-outline-primary"
                                                                id="kb-goals-config">
                                                                <i class="bx bx-cog me-1"></i>Definir metas
                                                            </button>
                                                        </div>
                                                        <div id="kb-goals-clients" class="d-flex flex-column gap-2">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-12 col-xl-8">
                                                <div class="card border">
                                                    <div
                                                        class="card-header d-flex align-items-center justify-content-between">
                                                        <h5 class="mb-0"><i class="bx bx-user-check me-2"></i>Metas
                                                            por pessoa</h5>
                                                        <button class="btn btn-outline-secondary btn-sm"
                                                            id="kb-reset-mock">
                                                            <i class="bx bx-reset me-1"></i> Reset mock
                                                        </button>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="table-responsive text-nowrap">
                                                            <table class="table table-hover align-middle">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Pessoa</th>
                                                                        <th>On-time</th>
                                                                        <th>Qualidade</th>
                                                                        <th>Retrabalho</th>
                                                                        <th>Tempo (estimado x real)</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="goals-table-body"></tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>

                                    </div>

                                </div>

                                <!-- =================== MODAL: Criar/Editar =================== -->
                                <div class="modal fade" id="kbModalCreate" tabindex="-1"
                                    aria-labelledby="kbModalCreateLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="kbModalCreateLabel"><i
                                                        class="bx bx-plus-circle me-2"></i>Novo card</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Fechar"></button>
                                            </div>

                                            <div class="modal-body">
                                                <form id="kb-form">
                                                    <input type="hidden" id="kb-id" />

                                                    <div class="row g-3">
                                                        <div class="col-12 col-lg-8">
                                                            <label class="form-label">Título</label>
                                                            <input id="kb-title" class="form-control" maxlength="120"
                                                                required
                                                                placeholder="Ex.: Ajustar criativos do Café Carneiro" />
                                                        </div>

                                                        <div class="col-6 col-lg-2">
                                                            <label class="form-label">Prioridade</label>
                                                            <select id="kb-priority" class="form-select" required>
                                                                <option value="P1">P1</option>
                                                                <option value="P0">P0</option>
                                                                <option value="P2">P2</option>
                                                                <option value="P3">P3</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-12 col-lg-4">
                                                            <label class="form-label">Cliente</label>
                                                            <select id="kb-client" class="form-select"
                                                                required></select>
                                                        </div>
                                                        <div class="col-12 col-lg-4">
                                                            <label class="form-label">Briefing (líder)</label>
                                                            <select id="kb-briefing-owner" class="form-select"
                                                                required></select>
                                                        </div>

                                                        <div class="col-6 col-lg-2">
                                                            <label class="form-label">Responsável: Arte</label>
                                                            <select id="kb-role-design" class="form-select"
                                                                required></select>
                                                        </div>

                                                        <div class="col-6 col-lg-2">
                                                            <label class="form-label">Responsável: Legenda/Copy</label>
                                                            <select id="kb-role-text" class="form-select"
                                                                required></select>
                                                        </div>
                                                        <div class="col-4 col-lg-2">
                                                            <label class="form-label">Est. Design (h)</label>
                                                            <input id="kb-est-design" type="number" min="0" step="0.5"
                                                                class="form-control" value="2" />
                                                        </div>

                                                        <div class="col-4 col-lg-2">
                                                            <label class="form-label">Est. Texto (h)</label>
                                                            <input id="kb-est-text" type="number" min="0" step="0.5"
                                                                class="form-control" value="1" />
                                                        </div>

                                                        <div class="col-4 col-lg-2">
                                                            <label class="form-label">Est. Agendar (h)</label>
                                                            <input id="kb-est-schedule" type="number" min="0" step="0.5"
                                                                class="form-control" value="0.5" />
                                                        </div>
                                                        <div class="col-12 col-lg-4">
                                                            <label class="form-label">Prazo</label>
                                                            <input id="kb-due" type="date" class="form-control" />
                                                        </div>

                                                        <div class="col-6 col-lg-4">
                                                            <label class="form-label">Tags (vírgula)</label>
                                                            <input id="kb-tags" class="form-control"
                                                                placeholder="ex.: criativo, meta, sprint-12" />
                                                        </div>

                                                        <div class="col-6 col-lg-4">
                                                            <label class="form-label">Retrabalho
                                                                (alterações)</label>
                                                            <input id="kb-rework" type="number" min="0" step="1"
                                                                class="form-control" value="0" />
                                                        </div>

                                                        <!-- NOVO: campos que alimentam o Detalhes (arte/copy/briefing) -->
                                                        <div class="col-12 col-lg-6">
                                                            <label class="form-label">Briefing (o que precisa ser
                                                                feito)</label>
                                                            <textarea id="kb-briefing" class="form-control" rows="4"
                                                                placeholder="Objetivo, referências, público, regras..."></textarea>
                                                        </div>
                                                        <div class="col-12">
                                                            <label class="form-label">Descrição rápida</label>
                                                            <textarea id="kb-desc" class="form-control" rows="2"
                                                                placeholder="Contexto curto (visão geral)..."></textarea>
                                                        </div>

                                                    </div>
                                                </form>
                                            </div>

                                            <div class="modal-footer">
                                                <button class="btn btn-outline-secondary"
                                                    data-bs-dismiss="modal">Cancelar</button>
                                                <button class="btn btn-primary" id="kb-save"><i
                                                        class="bx bx-save me-1"></i>Salvar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- =================== MODAL: Detalhes (REFEITO) =================== -->
                                <div class="modal fade" id="kbModalDetails" tabindex="-1"
                                    aria-labelledby="kbModalDetailsLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl modal-dialog-centered">
                                        <div class="modal-content">

                                            <div class="modal-header">
                                                <div>
                                                    <h5 class="modal-title" id="kbModalDetailsLabel"><i
                                                            class="bx bx-detail me-2"></i>Detalhes do card</h5>
                                                    <div class="small text-muted" id="kb-details-subtitle"></div>
                                                </div>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Fechar"></button>
                                            </div>

                                            <div class="modal-body">

                                                <!-- Arte(s) no topo -->
                                                <div class="kb-asset-wrap mb-3">
                                                    <div
                                                        class="kb-asset-top d-flex align-items-center justify-content-between">
                                                        <div class="fw-medium"><i class="bx bx-image me-2"></i>Artes
                                                        </div>
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-outline-secondary btn-sm"
                                                                id="kb-add-assets-btn">
                                                                <i class="bx bx-upload me-1"></i> Adicionar artes
                                                            </button>
                                                            <input id="kb-assets-file" type="file" class="d-none"
                                                                multiple accept="image/*">
                                                            <button class="btn btn-outline-primary btn-sm"
                                                                id="kb-edit-from-details">
                                                                <i class="bx bx-edit-alt me-1"></i> Editar
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <div id="kb-assets-area" class="kb-assets-area">
                                                        <!-- renderiza via JS -->
                                                    </div>
                                                </div>

                                                <div class="row g-3">
                                                    <!-- Conteúdo compartilhado do card -->
                                                    <div class="col-12 col-lg-7">
                                                        <div class="card border">
                                                            <div class="card-body">
                                                                <div
                                                                    class="d-flex justify-content-between align-items-start">
                                                                    <div>
                                                                        <h5 class="mb-1" id="kb-details-title">—
                                                                        </h5>
                                                                        <div class="d-flex flex-wrap gap-2 mt-2"
                                                                            id="kb-details-badges"></div>
                                                                    </div>
                                                                </div>

                                                                <hr />

                                                                <!-- Tabs: Copy / Briefing / Checklist / Histórico -->
                                                                <ul class="nav nav-tabs" role="tablist">
                                                                    <li class="nav-item" role="presentation">
                                                                        <button class="nav-link active"
                                                                            data-bs-toggle="tab"
                                                                            data-bs-target="#kb-tab-copy" type="button"
                                                                            role="tab">
                                                                            <i
                                                                                class="bx bx-message-rounded-dots me-1"></i>
                                                                            Copy / Legenda
                                                                        </button>
                                                                    </li>
                                                                    <li class="nav-item" role="presentation">
                                                                        <button class="nav-link" data-bs-toggle="tab"
                                                                            data-bs-target="#kb-tab-briefing"
                                                                            type="button" role="tab">
                                                                            <i class="bx bx-notepad me-1"></i>
                                                                            Briefing
                                                                        </button>
                                                                    </li>
                                                                    <li class="nav-item" role="presentation">
                                                                        <button class="nav-link" data-bs-toggle="tab"
                                                                            data-bs-target="#kb-tab-checklist"
                                                                            type="button" role="tab">
                                                                            <i class="bx bx-list-check me-1"></i>
                                                                            Checklist
                                                                        </button>
                                                                    </li>
                                                                    <li class="nav-item" role="presentation">
                                                                        <button class="nav-link" data-bs-toggle="tab"
                                                                            data-bs-target="#kb-tab-client"
                                                                            type="button" role="tab">
                                                                            <i
                                                                                class="bx bx-message-square-dots me-1"></i>
                                                                            Cliente
                                                                        </button>
                                                                    </li>
                                                                    <li class="nav-item" role="presentation">
                                                                        <button class="nav-link" data-bs-toggle="tab"
                                                                            data-bs-target="#kb-tab-history"
                                                                            type="button" role="tab">
                                                                            <i class="bx bx-time-five me-1"></i>
                                                                            Histórico & Tempos
                                                                        </button>
                                                                    </li>
                                                                </ul>

                                                                <div class="tab-content pt-3">
                                                                    <div class="tab-pane fade show active"
                                                                        id="kb-tab-copy" role="tabpanel">
                                                                        <div class="text-muted small mb-2">Texto
                                                                            final (público)</div>
                                                                        <textarea id="kb-copy-input"
                                                                            class="form-control" rows="7"
                                                                            placeholder="Cole aqui a legenda/copy do post (responsável por texto)..."></textarea>
                                                                        <div class="d-flex justify-content-end mt-2">
                                                                            <button
                                                                                class="btn btn-outline-primary btn-sm"
                                                                                id="kb-copy-save">
                                                                                <i class="bx bx-save me-1"></i>Salvar
                                                                                texto
                                                                            </button>
                                                                        </div>
                                                                    </div>

                                                                    <div class="tab-pane fade" id="kb-tab-briefing"
                                                                        role="tabpanel">
                                                                        <div class="text-muted small mb-2">
                                                                            Orientações do job</div>
                                                                        <div id="kb-details-briefing" class="kb-pre">—
                                                                        </div>
                                                                        <hr />
                                                                        <div class="text-muted small mb-2">Descrição
                                                                            rápida</div>
                                                                        <div id="kb-details-desc" class="small">—
                                                                        </div>
                                                                    </div>

                                                                    <div class="tab-pane fade" id="kb-tab-checklist"
                                                                        role="tabpanel">
                                                                        <div class="text-muted small mb-2">Itens de
                                                                            entrega (mock)</div>
                                                                        <div id="kb-details-checklist"></div>
                                                                    </div>

                                                                    <div class="tab-pane fade" id="kb-tab-client"
                                                                        role="tabpanel">
                                                                        <div class="text-muted small mb-2">Comentários
                                                                            do cliente (aprovação e alterações)</div>

                                                                        <div id="kb-client-comments"
                                                                            class="d-flex flex-column gap-2 mb-3"></div>

                                                                        <div class="input-group">
                                                                            <select id="kb-client-comment-target"
                                                                                class="form-select"
                                                                                style="max-width: 190px;">
                                                                                <option value="comment" selected>
                                                                                    Comentário</option>
                                                                                <option value="design">Alteração: Arte
                                                                                </option>
                                                                                <option value="text">Alteração:
                                                                                    Legenda/Copy</option>
                                                                                <option value="both">Alteração: Geral
                                                                                </option>
                                                                            </select>
                                                                            <textarea id="kb-client-comment-text"
                                                                                class="form-control" rows="2"
                                                                                placeholder="Escreva como se fosse o cliente. (mock)"></textarea>
                                                                            <button class="btn btn-primary"
                                                                                id="kb-client-comment-add">
                                                                                <i class="bx bx-send"></i>
                                                                            </button>
                                                                        </div>

                                                                        <div class="form-text">
                                                                            Mock agora. Depois isso vira comentários
                                                                            reais do cliente dentro do portal.
                                                                        </div>
                                                                    </div>

                                                                    <div class="tab-pane fade" id="kb-tab-history"
                                                                        role="tabpanel">
                                                                        <div class="text-muted small mb-2">Tempo por
                                                                            etapa / responsável</div>
                                                                        <div class="table-responsive text-nowrap">
                                                                            <table
                                                                                class="table table-sm table-hover align-middle mb-0">
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th>Etapa</th>
                                                                                        <th>Responsável</th>
                                                                                        <th>Entrou</th>
                                                                                        <th>Saiu</th>
                                                                                        <th>Duração</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody id="kb-details-timelog">
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Métricas do card -->
                                                    <div class="col-12 col-lg-5">
                                                        <div class="card border">
                                                            <div class="card-body">

                                                                <div class="row g-3">
                                                                    <div class="col-6">
                                                                        <div class="text-muted small">Estimado (h)
                                                                        </div>
                                                                        <div class="h5 mb-0" id="kb-details-estimate">0
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <div class="text-muted small">Real (h)</div>
                                                                        <div class="h5 mb-0" id="kb-details-actual">
                                                                            0</div>
                                                                    </div>

                                                                    <div class="col-6">
                                                                        <div class="text-muted small">Qualidade
                                                                            (0–100)</div>
                                                                        <div class="h5 mb-0" id="kb-details-quality">0
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <div class="text-muted small">Retrabalho
                                                                        </div>
                                                                        <div class="h5 mb-0" id="kb-details-rework">
                                                                            0</div>
                                                                    </div>

                                                                    <div class="col-12">
                                                                        <div class="d-flex justify-content-between">
                                                                            <span class="text-muted small">Progresso
                                                                                do card (mock)</span>
                                                                            <span class="small fw-medium"
                                                                                id="kb-details-progress-label">0%</span>
                                                                        </div>
                                                                        <div class="progress mt-2"
                                                                            style="height: 10px;">
                                                                            <div id="kb-details-progress"
                                                                                class="progress-bar" role="progressbar"
                                                                                style="width: 0%"></div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="col-6">
                                                                        <div class="text-muted small">Prazo</div>
                                                                        <div class="fw-medium" id="kb-details-due">—
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <div class="text-muted small">Publicado em
                                                                        </div>
                                                                        <div class="fw-medium" id="kb-details-doneAt">—
                                                                        </div>
                                                                    </div>

                                                                    <div class="col-12">
                                                                        <div class="alert alert-secondary mb-0">
                                                                            <strong>Resultados
                                                                                (placeholder):</strong>
                                                                            <span class="small">você vai amarrar
                                                                                isso ao plano/objetivo do cliente
                                                                                depois.</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <hr />

                                                                <div class="d-flex gap-2 justify-content-end">
                                                                    <button class="btn btn-outline-danger"
                                                                        id="kb-delete">
                                                                        <i class="bx bx-trash me-1"></i> Excluir
                                                                    </button>
                                                                    <div id="kb-actions"
                                                                        class="d-flex flex-wrap gap-2 justify-content-end">
                                                                    </div>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <style>
                                    /* Board maior, colunas largas e aproveitando espaço */
                                    .kb-board-scroll {
                                        overflow-x: auto;
                                        padding-bottom: 6px;
                                    }

                                    .kb-board {
                                        display: flex;
                                        flex-wrap: nowrap;
                                        gap: 16px;
                                        min-height: 420px;
                                    }

                                    .kb-col {
                                        flex: 0 0 420px;
                                    }

                                    @media (min-width: 1600px) {
                                        .kb-col {
                                            flex-basis: 520px;
                                        }
                                    }

                                    .kb-col-card .card-body {
                                        min-height: 520px;
                                    }

                                    .kb-dropzone {
                                        min-height: 500px;
                                        padding: .25rem;
                                        border-radius: .5rem;
                                    }

                                    .kb-dropzone.kb-over {
                                        outline: 2px dashed rgba(105, 108, 255, 0.6);
                                        outline-offset: 4px;
                                        background: rgba(105, 108, 255, 0.06);
                                    }

                                    /* Cards: mostrar só marcações necessárias (prioridade + prazo + retrabalho) */
                                    .kb-card {
                                        border: 1px solid rgba(67, 89, 113, 0.15);
                                        border-radius: .6rem;
                                        padding: .8rem;
                                        margin-bottom: .75rem;
                                        background: #fff;
                                        cursor: grab;
                                        transition: transform .08s ease, box-shadow .08s ease;
                                    }

                                    .kb-card:active {
                                        cursor: grabbing;
                                    }

                                    .kb-card:hover {
                                        box-shadow: 0 8px 22px rgba(67, 89, 113, 0.10);
                                        transform: translateY(-1px);
                                    }

                                    .kb-title {
                                        font-weight: 600;
                                        line-height: 1.2;
                                        margin-bottom: .25rem;
                                    }

                                    .kb-meta {
                                        font-size: .80rem;
                                        color: rgba(67, 89, 113, 0.75);
                                    }

                                    .kb-empty {
                                        border: 1px dashed rgba(67, 89, 113, 0.25);
                                        border-radius: .6rem;
                                        padding: .85rem;
                                        text-align: center;
                                        color: rgba(67, 89, 113, 0.75);
                                        font-size: .875rem;
                                        background: rgba(67, 89, 113, 0.03);
                                    }

                                    /* Detalhes: artes no topo */
                                    .kb-asset-wrap {
                                        border: 1px solid rgba(67, 89, 113, 0.15);
                                        border-radius: .8rem;
                                        overflow: hidden;
                                    }

                                    .kb-asset-top {
                                        padding: 12px 14px;
                                        background: rgba(67, 89, 113, 0.03);
                                        border-bottom: 1px solid rgba(67, 89, 113, 0.10);
                                    }

                                    .kb-assets-area {
                                        padding: 12px;
                                        display: flex;
                                        gap: 12px;
                                        overflow-x: auto;
                                    }

                                    .kb-asset {
                                        flex: 0 0 320px;
                                        border: 1px solid rgba(67, 89, 113, 0.12);
                                        border-radius: .8rem;
                                        overflow: hidden;
                                        background: #fff;
                                    }

                                    .kb-asset img {
                                        display: block;
                                        width: 100%;
                                        height: 210px;
                                        object-fit: cover;
                                    }

                                    .kb-asset .kb-asset-caption {
                                        padding: 10px 12px;
                                        font-size: .85rem;
                                        color: rgba(67, 89, 113, 0.85);
                                    }

                                    .kb-pre {
                                        white-space: pre-wrap;
                                        word-break: break-word;
                                    }
                                </style>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- / Layout page -->
    </div>
    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
    </div>

    <!-- Modal: Assinatura / Pagamento -->
    <div class="modal fade" id="billingModal" tabindex="-1" aria-labelledby="billingModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="billingModalLabel">
                        <i class="bx bx-credit-card me-2"></i> Assinatura da plataforma
                    </h5>
                    <!-- Sem botão de fechar para forçar decisão -->
                </div>

                <div class="modal-body">
                    <div id="billing-alert" class="alert alert-info" role="alert" style="display:none;"></div>

                    <!-- Status atual -->
                    <div id="billing-status" class="mb-3">
                        <small class="text-muted">Verificando sua assinatura…</small>
                    </div>

                    <!-- Cupom 
                    <div class="mb-3">
                        <label for="couponInput" class="form-label">Cupom (opcional)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bx bx-purchase-tag-alt"></i></span>
                            <input type="text" id="couponInput" class="form-control" placeholder="EX.: BEMVINDO10">
                        </div>
                    </div>-->

                    <!-- Planos -->
                    <div class="mb-2">
                        <h6 class="mb-1">Escolha um plano</h6>
                        <!--<small class="text-muted">Os valores são carregados automaticamente dos seus planos.</small>-->
                    </div>
                    <div id="plansGrid" class="row g-3">
                        <!-- Cartões de planos serão injetados aqui via JS -->
                    </div>
                </div>

                <div class="modal-footer d-flex justify-content-between">
                    <button id="openPortalBtn" type="button" class="btn btn-outline-secondary" disabled>
                        Gerenciar pagamento (Portal)
                    </button>
                    <div class="d-flex gap-2">
                        <a href="/settingsAccountPage.html" class="btn btn-light">Ver opções completas</a>
                        <button id="closeBillingBtn" type="button" class="btn btn-secondary">Fechar</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Fale Conosco -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel">
                        <i class="bi bi-headset me-2"></i>Fale Conosco
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                    <p class="mb-2"><i class="bi bi-telephone me-2 text-primary"></i><strong>Telefone:</strong>
                        +55 19
                        99714-8221 </p>
                    <p class="mb-2"><i class="bi bi-envelope me-2 text-danger"></i><strong>Email:</strong>
                        contato@hokocomunicacao.com.br</p>
                    <p class="mb-0"><i class="bi bi-geo-alt me-2 text-success"></i><strong>Endereço:</strong> R.
                        Comendador Tórlogo Dauntre, n.74 Sala 1207
                        13.025-270
                        Cambui, Campinas SP</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Jeferson: container para mensagem -->
    <div id="alert-container"></div>

    <!-- Core JS -->
    <!-- build:js assets/vendor/js/core.js -->

    <script src="/assets/vendor/libs/jquery/jquery.js"></script>
    <script src="/assets/vendor/libs/popper/popper.js"></script>
    <script src="/assets/vendor/js/bootstrap.js"></script>
    <script src="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="/assets/vendor/js/menu.js"></script>

    <!-- Main JS -->
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/notifications.js"></script>

    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <!-- Jeferson: dados do cliente logado -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Jeferson: dados do cliente logado -->
    <script src="/assets/js/foodModelPage.js"></script>
    <!-- Jeferson: Check pagamentos -->
    <script src="/assets/js/checkPayments.js"></script>



    <!-- =================== MODAL: Metas por cliente (mock) =================== -->
    <div class="modal fade" id="kbModalGoals" tabindex="-1" aria-labelledby="kbModalGoalsLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="kbModalGoalsLabel"><i class="bx bx-target-lock me-2"></i>Metas por
                        cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2 mb-3">
                        Defina metas simples por cliente (mock). Isso alimenta o bloco de <b>Resultados por cliente</b>.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th class="text-nowrap">Posts/mês</th>
                                    <th class="text-nowrap">% no prazo</th>
                                    <th class="text-nowrap">Qualidade meta</th>
                                    <th class="text-nowrap">Retrabalho máx.</th>
                                </tr>
                            </thead>
                            <tbody id="kb-goals-table-body"></tbody>
                        </table>
                    </div>

                    <div class="form-text">
                        Qualidade (mock) = 100 - retrabalho - atraso. (Depois amarra com objetivo real do cliente.)
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary" id="kb-goals-save"><i class="bx bx-save me-1"></i>Salvar
                        metas</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const STORAGE_KEY = "hoko_kanban_mock_v3";

            // ========= STATUS (fluxo real ho.ko) =========
            const STATUS = [
                { key: "backlog", label: "Backlog" },
                { key: "doing", label: "Em andamento" },
                { key: "approval", label: "Em aprovação" },
                { key: "changes", label: "Alteração necessária" },
                { key: "approved", label: "Aprovados" },
                { key: "scheduled", label: "Agendados" },
                { key: "published", label: "Publicados" },
            ];

            const PRIORITY_BADGE = {
                P0: "bg-label-danger",
                P1: "bg-label-warning",
                P2: "bg-label-primary",
                P3: "bg-label-secondary",
            };

            const STATUS_BADGE = {
                backlog: "bg-label-secondary",
                doing: "bg-label-primary",
                approval: "bg-label-warning",
                changes: "bg-label-danger",
                approved: "bg-label-success",
                scheduled: "bg-label-info",
                published: "bg-label-dark",
            };

            // ========= MOCK DATA =========
            const MOCK_CLIENTS = ["ho.ko Comunicação", "Café Carneiro", "Imunocamp", "CPN Engenharia"];

            function makeDefaultClientGoals() {
                const goals = {};
                MOCK_CLIENTS.forEach(client => {
                    goals[client] = {
                        postsPerMonth: 12,
                        ontimePct: 90,
                        quality: 85,
                        maxRework: 2,
                    };
                });
                return goals;
            }

            function ensureClientGoals() {
                if (!state.clientGoals || typeof state.clientGoals !== "object") state.clientGoals = {};
                MOCK_CLIENTS.forEach(client => {
                    if (!state.clientGoals[client]) state.clientGoals[client] = {
                        postsPerMonth: 12,
                        ontimePct: 90,
                        quality: 85,
                        maxRework: 2,
                    };
                });
            }


            const MOCK_MEMBERS = [
                { id: "m1", name: "Duda (Briefing)" },
                { id: "m2", name: "Ray (Design)" },
                { id: "m3", name: "Scar (Texto)" },
                { id: "m4", name: "Fe (Líder)" },
            ];

            // ========= Helpers =========
            const $ = (sel) => document.querySelector(sel);
            const $$ = (sel) => Array.from(document.querySelectorAll(sel));

            function escapeHtml(str) {
                return String(str ?? "")
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }
            function escapeAttr(str) { return escapeHtml(str).replaceAll("`", "&#096;"); }

            function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

            function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

            function fmtDate(isoOrDate) {
                if (!isoOrDate) return "—";
                const d = new Date(isoOrDate);
                if (isNaN(d.getTime())) return "—";
                return d.toLocaleDateString("pt-BR");
            }

            function fmtDateTime(isoOrDate) {
                if (!isoOrDate) return "—";
                const d = new Date(isoOrDate);
                if (isNaN(d.getTime())) return "—";
                return d.toLocaleString("pt-BR");
            }

            function diffHours(startIso, endIso) {
                if (!startIso || !endIso) return 0;
                const a = new Date(startIso).getTime();
                const b = new Date(endIso).getTime();
                if (!a || !b) return 0;
                return Math.max(0, (b - a) / 36e5);
            }

            function fillOptions(select, options) {
                if (!select) return;
                const cur = select.value;
                select.innerHTML = options.map(o => `<option value="${escapeAttr(o.value)}">${escapeHtml(o.label)}</option>`).join("");
                if (options.some(o => o.value === cur)) select.value = cur;
            }

            function showFeedback(message, type = "success") {
                const el = $("#kanban-feedback");
                if (!el) return;
                el.className = `alert alert-${type}`;
                el.style.display = "block";
                el.textContent = message;
                clearTimeout(showFeedback._t);
                showFeedback._t = setTimeout(() => { el.style.display = "none"; }, 2600);
            }

            function memberName(id) {
                return MOCK_MEMBERS.find(m => m.id === id)?.name || "—";
            }

            function statusLabel(key) {
                return STATUS.find(s => s.key === key)?.label || key;
            }

            function calcQuality(card) {
                // simples e factual ao seu fluxo:
                // - 0 retrabalho => 100
                // - cada solicitação de alteração do cliente derruba 15 pontos (min 0)
                const penalties = 15 * Number(card.feedbackCount || 0);
                return clamp(100 - penalties, 0, 100);
            }

            function isOnTime(card) {
                if (!card.dueDate || !card.publishedAt) return null;
                const due = new Date(card.dueDate);
                // considera fim do dia
                due.setHours(23, 59, 59, 999);
                return new Date(card.publishedAt) <= due;
            }

            function getTotalEstimate(card) {
                const r = card.roles || {};
                const sum = (r.design?.estimateHours || 0) + (r.text?.estimateHours || 0) + (r.schedule?.estimateHours || 0);
                return Math.round(sum * 10) / 10;
            }

            function getTotalReal(card) {
                const runs = Array.isArray(card.roleRuns) ? card.roleRuns : [];
                const sum = runs.reduce((a, run) => a + diffHours(run.startedAt, run.endedAt), 0);
                return Math.round(sum * 10) / 10;
            }

            function calcProgress(card) {
                // progress visual simples, baseado no estágio + roles concluídos
                const s = card.status;
                if (s === "published") return 100;
                if (s === "scheduled") return 95;
                if (s === "approved") return 85;
                if (s === "approval") return 75;
                if (s === "changes") return 65;
                if (s === "doing") {
                    const designDone = !!card.roles?.design?.doneAt;
                    const textDone = !!card.roles?.text?.doneAt;
                    return 30 + (designDone ? 20 : 0) + (textDone ? 20 : 0);
                }
                return 5; // backlog
            }

            // ========= State =========
            function defaultMock() {
                const now = new Date();
                const iso = now.toISOString();

                // cards prontos para testar o fluxo
                const c1 = makeCard({
                    title: "Revisar calendário editorial (Jan)",
                    client: "ho.ko Comunicação",
                    priority: "P1",
                    dueDate: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2).toISOString().slice(0, 10),
                    briefing: "Checar temas + ajustar tom de voz.",
                    briefingOwnerId: "m1",
                    designOwnerId: "m2",
                    textOwnerId: "m3",
                    status: "backlog",
                });

                const c2 = makeCard({
                    title: "Criar variações de criativos (Meta Ads)",
                    client: "Café Carneiro",
                    priority: "P0",
                    dueDate: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString().slice(0, 10),
                    briefing: "Criar 3 variações de criativo para campanha de conversão.",
                    briefingOwnerId: "m4",
                    designOwnerId: "m2",
                    textOwnerId: "m3",
                    status: "doing",
                });
                // simula início da produção
                enterStatus(c2, "doing", iso);

                const c3 = makeCard({
                    title: "Ajustar LP de agendamento (CTA + tracking)",
                    client: "Imunocamp",
                    priority: "P1",
                    dueDate: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3).toISOString().slice(0, 10),
                    briefing: "Revisar CTA e eventos de tracking.",
                    briefingOwnerId: "m1",
                    designOwnerId: "m2",
                    textOwnerId: "m3",
                    status: "approval",
                });
                enterStatus(c3, "approval", iso);
                c3.copyText = "Legenda (mock) pronta para aprovação.";
                c3.assets = []; // vazio (upload depois)
                c3.clientComments.push({ id: uid(), at: iso, author: "Cliente", text: "Podem enviar mais 1 opção de arte?" });
                c3.feedbackCount = 1;

                return {
                    cards: [c1, c2, c3],
                    clientGoals: makeDefaultClientGoals(),
                };
            }

            function loadState() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return defaultMock();
                    const parsed = JSON.parse(raw);
                    if (!parsed || !Array.isArray(parsed.cards)) return defaultMock();
                    if (!parsed.clientGoals) parsed.clientGoals = makeDefaultClientGoals();
                    return parsed;
                } catch {
                    return defaultMock();
                }
            }

            function saveState() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }

            let state = loadState();
            ensureClientGoals();
            let selectedCardId = null;

            // ========= Card factory =========
            function makeCard(payload) {
                const nowIso = new Date().toISOString();

                const card = {
                    id: payload.id || uid(),
                    title: payload.title || "",
                    client: payload.client || "",
                    priority: payload.priority || "P1",
                    status: payload.status || "backlog",

                    dueDate: payload.dueDate || null,
                    tags: payload.tags || [],

                    briefing: payload.briefing || "",
                    desc: payload.desc || "",
                    copyText: payload.copyText || "",

                    assets: Array.isArray(payload.assets) ? payload.assets : [], // dataURLs
                    clientComments: Array.isArray(payload.clientComments) ? payload.clientComments : [],

                    // qualidade
                    feedbackCount: Number(payload.feedbackCount || 0),

                    // papéis fixos do card (quem foi designado na criação)
                    owners: {
                        briefing: payload.briefingOwnerId || (MOCK_MEMBERS[0]?.id || "m1"),
                        design: payload.designOwnerId || (MOCK_MEMBERS[1]?.id || "m2"),
                        text: payload.textOwnerId || (MOCK_MEMBERS[2]?.id || "m3"),
                    },

                    // roles com estado (ativo / concluído / estimativas)
                    roles: {
                        design: {
                            memberId: payload.designOwnerId || (MOCK_MEMBERS[1]?.id || "m2"),
                            estimateHours: Number(payload.estDesign ?? 2),
                            doneAt: null,
                            active: false,
                        },
                        text: {
                            memberId: payload.textOwnerId || (MOCK_MEMBERS[2]?.id || "m3"),
                            estimateHours: Number(payload.estText ?? 1),
                            doneAt: null,
                            active: false,
                        },
                        schedule: {
                            memberId: payload.briefingOwnerId || (MOCK_MEMBERS[0]?.id || "m1"),
                            estimateHours: Number(payload.estSchedule ?? 0.5),
                            doneAt: null,
                            active: false,
                        },
                    },

                    // time tracking por role (cada “rodada” vira uma linha)
                    roleRuns: [],

                    createdAt: nowIso,
                    approvedAt: null,
                    scheduledAt: null,
                    publishedAt: null,

                    history: [
                        { id: uid(), type: "created", at: nowIso, by: payload.briefingOwnerId || null },
                        { id: uid(), type: "status", from: null, to: payload.status || "backlog", at: nowIso },
                    ],
                };

                // se já nasce em doing/approval/etc, ajusta "entrada"
                enterStatus(card, card.status, nowIso, { silentHistory: true });

                return card;
            }

            // ========= Status + Roles =========
            function enterStatus(card, newStatus, atIso, opts = {}) {
                const old = card.status;
                card.status = newStatus;

                if (!opts.silentHistory) {
                    card.history.unshift({ id: uid(), type: "status", from: old, to: newStatus, at: atIso });
                }

                // ativação padrão de roles por status
                if (newStatus === "doing") {
                    activateRole(card, "design", atIso);
                    activateRole(card, "text", atIso);
                }

                if (newStatus === "changes") {
                    // ativa apenas os que precisam (se não houver alvo, ativa ambos)
                    const targets = Array.isArray(card.changeTargets) && card.changeTargets.length ? card.changeTargets : ["design", "text"];
                    targets.forEach(role => activateRole(card, role, atIso));
                }

                if (newStatus === "approved") {
                    // entra briefing (agendamento)
                    activateRole(card, "schedule", atIso);
                    card.approvedAt = card.approvedAt || atIso;
                }

                if (newStatus === "scheduled") {
                    card.scheduledAt = card.scheduledAt || atIso;
                }

                if (newStatus === "published") {
                    card.publishedAt = card.publishedAt || atIso;
                }
            }

            function activateRole(card, roleKey, atIso) {
                const role = card.roles?.[roleKey];
                if (!role) return;

                // já está ativo? não duplica
                if (role.active) return;

                role.active = true;
                role.doneAt = null;

                card.roleRuns.unshift({
                    id: uid(),
                    role: roleKey,
                    status: card.status,
                    memberId: role.memberId,
                    startedAt: atIso,
                    endedAt: null,
                });

                card.history.unshift({ id: uid(), type: "role_active", role: roleKey, memberId: role.memberId, at: atIso });
            }

            function completeRole(cardId, roleKey) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card) return;

                const role = card.roles?.[roleKey];
                if (!role || !role.active) return;

                const atIso = new Date().toISOString();
                role.active = false;
                role.doneAt = atIso;

                // fecha run
                const run = (card.roleRuns || []).find(r => r.role === roleKey && !r.endedAt);
                if (run) run.endedAt = atIso;

                card.history.unshift({ id: uid(), type: "role_done", role: roleKey, memberId: role.memberId, at: atIso });

                // se estamos em doing/changes e não há mais roles ativas => automações de fluxo
                if ((card.status === "doing" || card.status === "changes") && !hasActiveRoles(card, ["design", "text"])) {
                    // do doing: vai pra aprovação
                    if (card.status === "doing") {
                        enterStatus(card, "approval", atIso);
                    } else {
                        // do changes: volta pra aprovação
                        enterStatus(card, "approval", atIso);
                        card.changeTargets = [];
                    }
                }

                // se estamos em approved (agendamento) e schedule terminou => vai pra scheduled
                if (card.status === "approved" && roleKey === "schedule") {
                    enterStatus(card, "scheduled", atIso);
                }

                saveState();
                render();
                if (selectedCardId === cardId) openDetails(cardId);
            }

            function hasActiveRoles(card, keys) {
                return keys.some(k => card.roles?.[k]?.active);
            }

            // ========= Client actions =========
            function approveCard(cardId) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card || card.status !== "approval") return;

                const atIso = new Date().toISOString();
                card.history.unshift({ id: uid(), type: "client_approved", at: atIso });
                enterStatus(card, "approved", atIso);

                saveState();
                render();
                if (selectedCardId === cardId) openDetails(cardId);
                showFeedback("Cliente aprovou. Card enviado para Aprovados (agendamento).", "success");
            }

            function requestChange(cardId, targets) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card || card.status !== "approval") return;

                const atIso = new Date().toISOString();

                card.feedbackCount = Number(card.feedbackCount || 0) + 1;
                card.changeTargets = targets;

                card.history.unshift({ id: uid(), type: "client_change", targets, at: atIso });
                enterStatus(card, "changes", atIso);

                // se pedir alteração no texto, limpa o copy (pra ficar factual com o fluxo)
                if (targets.includes("text")) card.copyText = "";

                saveState();
                render();
                if (selectedCardId === cardId) openDetails(cardId);
                showFeedback("Alteração solicitada. Card foi para Alteração necessária.", "warning");
            }

            function markPublished(cardId) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card || card.status !== "scheduled") return;

                const atIso = new Date().toISOString();
                enterStatus(card, "published", atIso);

                saveState();
                render();
                if (selectedCardId === cardId) openDetails(cardId);
                showFeedback("Card marcado como Publicado.", "success");
            }

            // ========= Assets (upload local / mock) =========
            function addAssetsFromFiles(cardId, files) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card) return;

                const list = Array.from(files || []);
                if (!list.length) return;

                // limita para evitar estourar localStorage
                const MAX_FILES = 6;
                const MAX_SIZE = 900 * 1024; // 900KB

                const allowed = list.slice(0, MAX_FILES);

                const reads = allowed.map(file => new Promise((resolve, reject) => {
                    if (file.size > MAX_SIZE) {
                        return resolve({ ok: false, name: file.name, reason: "Arquivo muito grande (mock limita 900KB)." });
                    }
                    const reader = new FileReader();
                    reader.onload = () => resolve({ ok: true, dataUrl: String(reader.result), name: file.name });
                    reader.onerror = () => resolve({ ok: false, name: file.name, reason: "Falha ao ler arquivo." });
                    reader.readAsDataURL(file);
                }));

                Promise.all(reads).then(results => {
                    const ok = results.filter(r => r.ok).map(r => r.dataUrl);
                    const bad = results.filter(r => !r.ok);

                    if (!Array.isArray(card.assets)) card.assets = [];
                    card.assets = card.assets.concat(ok).slice(0, 10);

                    if (ok.length) {
                        card.history.unshift({ id: uid(), type: "assets_added", count: ok.length, at: new Date().toISOString() });
                    }

                    saveState();
                    render();
                    if (selectedCardId === cardId) openDetails(cardId);

                    if (bad.length) {
                        showFeedback(`Alguns arquivos não foram adicionados: ${bad.map(b => b.name).join(", ")}`, "warning");
                    } else {
                        showFeedback("Artes adicionadas ao card.", "success");
                    }
                });
            }

            // ========= Copy (texto) =========
            function saveCopy(cardId, text) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card) return;

                card.copyText = (text || "").trim();
                card.history.unshift({ id: uid(), type: "copy_saved", at: new Date().toISOString() });

                saveState();
                render();
                if (selectedCardId === cardId) openDetails(cardId);
                showFeedback("Texto salvo no card.", "success");
            }

            // ========= Client comments =========
            function addClientComment(cardId, text) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card) return;

                const t = (text || "").trim();
                if (!t) return;

                card.clientComments.unshift({ id: uid(), at: new Date().toISOString(), author: "Cliente", text: t });
                card.history.unshift({ id: uid(), type: "client_comment", at: new Date().toISOString() });

                saveState();
                render();
                if (selectedCardId === cardId) openDetails(cardId);
            }

            // ========= Filters =========
            function getFilters() {
                return {
                    q: ($("#kb-search")?.value || "").trim().toLowerCase(),
                    client: $("#kb-filter-client")?.value || "all",
                    member: $("#kb-filter-member")?.value || "all",
                    priority: $("#kb-filter-priority")?.value || "all",
                };
            }

            function cardActiveMembers(card) {
                // backlog: briefing
                if (card.status === "backlog") return [card.owners?.briefing].filter(Boolean);

                // doing/changes: roles ativas
                if (card.status === "doing" || card.status === "changes") {
                    const act = [];
                    if (card.roles?.design?.active) act.push(card.roles.design.memberId);
                    if (card.roles?.text?.active) act.push(card.roles.text.memberId);
                    return act.filter(Boolean);
                }

                // approved: schedule role ativo
                if (card.status === "approved" && card.roles?.schedule?.active) return [card.roles.schedule.memberId];

                // demais: sem responsável ativo (cliente/automação)
                return [];
            }

            function applyFilters(list) {
                const f = getFilters();
                return list.filter(c => {
                    if (f.client !== "all" && c.client !== f.client) return false;
                    if (f.priority !== "all" && c.priority !== f.priority) return false;

                    if (f.member !== "all") {
                        const act = cardActiveMembers(c);
                        if (!act.includes(f.member)) return false;
                    }

                    if (f.q) {
                        const hay = [
                            c.title, c.client, (c.tags || []).join(" "),
                            c.briefing, c.copyText
                        ].join(" ").toLowerCase();
                        if (!hay.includes(f.q)) return false;
                    }

                    return true;
                });
            }

            // ========= Render board =========
            function render() {
                const all = state.cards || [];
                const filtered = applyFilters(all);

                // counts
                const count = (k) => filtered.filter(c => c.status === k).length;
                $("#count-backlog").textContent = `(${count("backlog")})`;
                $("#count-doing").textContent = `(${count("doing")})`;
                $("#count-approval").textContent = `(${count("approval")})`;
                $("#count-changes").textContent = `(${count("changes")})`;
                $("#count-approved").textContent = `(${count("approved")})`;
                $("#count-scheduled").textContent = `(${count("scheduled")})`;
                $("#count-published").textContent = `(${count("published")})`;

                // summary
                const wip = filtered.filter(c => c.status === "doing" || c.status === "changes").length;
                $("#sum-wip").textContent = String(wip);

                const published = filtered.filter(c => c.status === "published" && c.publishedAt && c.dueDate);
                const ontime = published.filter(c => isOnTime(c) === true).length;
                const ontimePct = published.length ? Math.round((ontime / published.length) * 100) : 0;
                $("#sum-ontime").textContent = `${ontimePct}%`;

                const qAvg = filtered.length ? Math.round(filtered.reduce((a, c) => a + calcQuality(c), 0) / filtered.length) : 0;
                $("#sum-quality").textContent = String(qAvg);

                const rework = filtered.reduce((a, c) => a + Number(c.feedbackCount || 0), 0);
                $("#sum-rework").textContent = String(rework);

                // board content
                $$(".kb-dropzone").forEach(z => z.innerHTML = "");

                filtered.forEach(card => {
                    const z = document.querySelector(`.kb-dropzone[data-status="${card.status}"]`);
                    if (!z) return;
                    z.insertAdjacentHTML("beforeend", renderCard(card));
                });

                // fill selects
                fillSelects();

                // bind per-card events
                bindCardEvents();

                // goals tab
                renderGoals();
            }

            function renderCard(card) {
                const activeMembers = cardActiveMembers(card).map(memberName);
                const st = statusLabel(card.status);

                const tags = (card.tags || []).slice(0, 3).map(t => `<span class="badge bg-label-secondary">${escapeHtml(t)}</span>`).join(" ");
                const due = card.dueDate ? `<span class="badge bg-label-info"><i class="bx bx-calendar me-1"></i>${fmtDate(card.dueDate)}</span>` : "";
                const rework = Number(card.feedbackCount || 0) ? `<span class="badge bg-label-danger"><i class="bx bx-revision me-1"></i>${Number(card.feedbackCount || 0)}</span>` : `<span class="badge bg-label-success"><i class="bx bx-check me-1"></i>0</span>`;
                const q = `<span class="badge bg-label-warning"><i class="bx bx-shield-quarter me-1"></i>${calcQuality(card)}</span>`;

                // responsáveis ativos no card (sai do quadro quando conclui)
                const owners = activeMembers.length
                    ? activeMembers.map(n => `<span class="badge bg-label-primary"><i class="bx bx-user me-1"></i>${escapeHtml(n)}</span>`).join(" ")
                    : `<span class="badge bg-label-secondary"><i class="bx bx-user-x me-1"></i>Sem responsável</span>`;

                const miniActions = renderMiniActions(card);

                return `
                <div class="kb-card" draggable="true" data-id="${escapeAttr(card.id)}">
                    <div class="d-flex justify-content-between align-items-start gap-2">
                        <div class="flex-grow-1">
                            <div class="fw-semibold">${escapeHtml(card.title)}</div>
                            <div class="small text-muted mt-1">${escapeHtml(card.client || "—")}</div>
                        </div>
                        <span class="badge ${PRIORITY_BADGE[card.priority] || "bg-label-secondary"}">${escapeHtml(card.priority || "P?")}</span>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <span class="badge ${STATUS_BADGE[card.status] || "bg-label-secondary"}">${escapeHtml(st)}</span>
                        ${due}
                        ${q}
                        ${rework}
                    </div>

                    <div class="d-flex flex-wrap gap-2 mt-2">
                        ${owners}
                    </div>

                    ${tags ? `<div class="d-flex flex-wrap gap-2 mt-2">${tags}</div>` : ""}

                    <div class="d-flex align-items-center justify-content-between mt-3">
                        <button class="btn btn-sm btn-outline-primary kb-open-details" data-id="${escapeAttr(card.id)}">
                            <i class="bx bx-detail me-1"></i> Ver detalhes
                        </button>
                        ${miniActions}
                    </div>
                </div>
            `;
            }

            function renderMiniActions(card) {
                // Botões no próprio card (pedido do seu fluxo)
                if (card.status === "doing" || card.status === "changes") {
                    const parts = [];
                    if (card.roles?.design?.active) parts.push(`<button class="btn btn-sm btn-success kb-role-done" data-role="design" data-id="${escapeAttr(card.id)}"><i class="bx bx-check me-1"></i>Arte</button>`);
                    if (card.roles?.text?.active) parts.push(`<button class="btn btn-sm btn-success kb-role-done" data-role="text" data-id="${escapeAttr(card.id)}"><i class="bx bx-check me-1"></i>Texto</button>`);
                    return parts.length ? `<div class="d-flex gap-2">${parts.join("")}</div>` : "";
                }
                if (card.status === "approved" && card.roles?.schedule?.active) {
                    return `<button class="btn btn-sm btn-success kb-role-done" data-role="schedule" data-id="${escapeAttr(card.id)}"><i class="bx bx-calendar-check me-1"></i>Agendar</button>`;
                }
                if (card.status === "scheduled") {
                    return `<button class="btn btn-sm btn-success kb-publish" data-id="${escapeAttr(card.id)}"><i class="bx bx-world me-1"></i>Publicar</button>`;
                }
                return "";
            }

            // ========= Drag & Drop (limitado) =========
            function initDragAndDrop() {
                $$(".kb-card").forEach(cardEl => {
                    cardEl.addEventListener("dragstart", (e) => {
                        cardEl.classList.add("opacity-50");
                        e.dataTransfer.setData("text/plain", cardEl.dataset.id);
                    });
                    cardEl.addEventListener("dragend", () => cardEl.classList.remove("opacity-50"));
                });

                $$(".kb-dropzone").forEach(zone => {
                    zone.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        zone.classList.add("kb-over");
                    });
                    zone.addEventListener("dragleave", () => zone.classList.remove("kb-over"));
                    zone.addEventListener("drop", (e) => {
                        e.preventDefault();
                        zone.classList.remove("kb-over");

                        const cardId = e.dataTransfer.getData("text/plain");
                        const toStatus = zone.dataset.status;
                        const card = state.cards.find(c => c.id === cardId);
                        if (!card) return;

                        // só permitimos backlog -> doing (o resto é por botões / automações)
                        if (!(card.status === "backlog" && toStatus === "doing")) {
                            showFeedback("Movimento bloqueado. Use os botões do fluxo (concluir/alterar/aprovar/agendar/publicar).", "info");
                            return;
                        }

                        const atIso = new Date().toISOString();
                        enterStatus(card, "doing", atIso);
                        saveState();
                        render();
                        showFeedback("Card iniciado: Backlog → Em andamento", "success");
                    });
                });
            }

            // ========= Selects =========
            function fillSelects() {
                // filtros
                fillOptions($("#kb-filter-client"), [{ value: "all", label: "Todos" }].concat(
                    Array.from(new Set((state.cards || []).map(c => c.client).filter(Boolean))).map(c => ({ value: c, label: c }))
                ));

                fillOptions($("#kb-filter-member"), [{ value: "all", label: "Todos" }].concat(
                    MOCK_MEMBERS.map(m => ({ value: m.id, label: m.name }))
                ));

                // form create/edit
                fillOptions($("#kb-client"), MOCK_CLIENTS.map(c => ({ value: c, label: c })));
                fillOptions($("#kb-briefing-owner"), MOCK_MEMBERS.map(m => ({ value: m.id, label: m.name })));
                fillOptions($("#kb-role-design"), MOCK_MEMBERS.map(m => ({ value: m.id, label: m.name })));
                fillOptions($("#kb-role-text"), MOCK_MEMBERS.map(m => ({ value: m.id, label: m.name })));
            }

            // ========= Modals =========
            const modalCreateEl = $("#kbModalCreate");
            const modalDetailsEl = $("#kbModalDetails");
            const modalGoalsEl = $("#kbModalGoals");

            const modalCreate = modalCreateEl ? new bootstrap.Modal(modalCreateEl) : null;
            const modalDetails = modalDetailsEl ? new bootstrap.Modal(modalDetailsEl) : null;
            const modalGoals = modalGoalsEl ? new bootstrap.Modal(modalGoalsEl) : null;

            function openCreate(editCard = null) {
                $("#kbModalCreateLabel").innerHTML = editCard
                    ? `<i class="bx bx-edit-alt me-2"></i>Editar card`
                    : `<i class="bx bx-plus-circle me-2"></i>Novo card`;

                $("#kb-id").value = editCard?.id || "";
                $("#kb-title").value = editCard?.title || "";
                $("#kb-desc").value = editCard?.desc || "";
                $("#kb-briefing").value = editCard?.briefing || "";

                $("#kb-client").value = editCard?.client || (MOCK_CLIENTS[0] || "");
                $("#kb-priority").value = editCard?.priority || "P1";

                $("#kb-briefing-owner").value = editCard?.owners?.briefing || (MOCK_MEMBERS[0]?.id || "m1");
                $("#kb-role-design").value = editCard?.owners?.design || (MOCK_MEMBERS[1]?.id || "m2");
                $("#kb-role-text").value = editCard?.owners?.text || (MOCK_MEMBERS[2]?.id || "m3");

                $("#kb-est-design").value = Number(editCard?.roles?.design?.estimateHours ?? 2);
                $("#kb-est-text").value = Number(editCard?.roles?.text?.estimateHours ?? 1);
                $("#kb-est-schedule").value = Number(editCard?.roles?.schedule?.estimateHours ?? 0.5);

                $("#kb-due").value = editCard?.dueDate || "";
                $("#kb-rework").value = Number(editCard?.feedbackCount ?? 0);
                $("#kb-tags").value = (editCard?.tags || []).join(", ");

                modalCreate?.show();
            }

            function openDetails(cardId) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card) return;
                selectedCardId = cardId;

                const stLabel = statusLabel(card.status);
                const actMembers = cardActiveMembers(card).map(memberName).join(", ") || "—";

                $("#kb-details-subtitle").textContent = `${card.client || "—"} • ${actMembers} • ${stLabel}`;
                $("#kb-details-title").textContent = card.title || "—";

                // badges
                const badges = [];
                badges.push(`<span class="badge ${PRIORITY_BADGE[card.priority] || "bg-label-secondary"}">${escapeHtml(card.priority || "P?")}</span>`);
                badges.push(`<span class="badge ${STATUS_BADGE[card.status] || "bg-label-secondary"}">${escapeHtml(stLabel)}</span>`);
                if (card.dueDate) badges.push(`<span class="badge bg-label-info"><i class="bx bx-calendar me-1"></i>${fmtDate(card.dueDate)}</span>`);
                badges.push(`<span class="badge bg-label-warning"><i class="bx bx-shield-quarter me-1"></i>${calcQuality(card)}</span>`);
                badges.push(`<span class="badge bg-label-danger"><i class="bx bx-revision me-1"></i>${Number(card.feedbackCount || 0)}</span>`);
                $("#kb-details-badges").innerHTML = badges.join("");

                // conteúdo
                $("#kb-copy-input").value = card.copyText || "";
                $("#kb-details-briefing").textContent = card.briefing || "—";
                $("#kb-details-desc").textContent = card.desc || "—";

                // assets
                $("#kb-assets-area").innerHTML = renderAssets(card);

                // checklist (mock)
                $("#kb-details-checklist").innerHTML = renderChecklist(card);

                // métricas
                $("#kb-details-estimate").textContent = String(getTotalEstimate(card));
                $("#kb-details-actual").textContent = String(getTotalReal(card));
                $("#kb-details-quality").textContent = String(calcQuality(card));
                $("#kb-details-rework").textContent = String(Number(card.feedbackCount || 0));

                const prog = calcProgress(card);
                $("#kb-details-progress-label").textContent = `${prog}%`;
                $("#kb-details-progress").style.width = `${prog}%`;

                $("#kb-details-due").textContent = fmtDate(card.dueDate);
                $("#kb-details-doneAt").textContent = fmtDate(card.publishedAt);

                // time log
                $("#kb-details-timelog").innerHTML = renderTimeLog(card);

                // client comments
                $("#kb-client-comments").innerHTML = renderClientComments(card);

                // actions (lado direito)
                $("#kb-actions").innerHTML = renderDetailsActions(card);

                modalDetails?.show();
            }

            function renderAssets(card) {
                const assets = Array.isArray(card.assets) ? card.assets.filter(Boolean) : [];
                if (!assets.length) {
                    return `<div class="text-muted small">Sem artes anexadas ainda. Use “Adicionar artes”.</div>`;
                }
                return assets.map((dataUrl, idx) => `
                <div class="kb-asset">
                    <img src="${escapeAttr(dataUrl)}" alt="Arte ${idx + 1}">
                    <div class="kb-asset-caption">Arte ${idx + 1}</div>
                </div>
            `).join("");
            }

            function renderChecklist(card) {
                // Mantive checklist como mock (melhoramos depois)
                const list = Array.isArray(card.checklist) ? card.checklist : [
                    { id: "c1", text: "Checklist: briefing validado", done: true },
                    { id: "c2", text: "Checklist: arte anexada", done: (card.assets || []).length > 0 },
                    { id: "c3", text: "Checklist: texto preenchido", done: !!(card.copyText || "").trim() },
                ];
                card.checklist = list;

                return `
                <div class="d-flex flex-column gap-2">
                    ${list.map(item => `
                        <label class="d-flex align-items-center gap-2">
                            <input type="checkbox" class="form-check-input kb-check-item" data-id="${escapeAttr(item.id)}" ${item.done ? "checked" : ""}>
                            <span class="${item.done ? "text-muted text-decoration-line-through" : ""}">${escapeHtml(item.text)}</span>
                        </label>
                    `).join("")}
                </div>
            `;
            }

            function renderTimeLog(card) {
                const runs = Array.isArray(card.roleRuns) ? card.roleRuns : [];
                if (!runs.length) {
                    return `<tr><td colspan="5" class="text-muted small">Sem histórico de tempo ainda.</td></tr>`;
                }

                return runs.map(r => {
                    const roleLabel = r.role === "design" ? "Arte" : r.role === "text" ? "Texto" : "Agendamento";
                    const stageLabel = statusLabel(r.status);
                    const dur = r.endedAt ? `${Math.round(diffHours(r.startedAt, r.endedAt) * 10) / 10}h` : "—";
                    return `
                    <tr>
                        <td>${escapeHtml(stageLabel)}</td>
                        <td>${escapeHtml(roleLabel)}</td>
                        <td>${escapeHtml(memberName(r.memberId))}</td>
                        <td>${fmtDateTime(r.startedAt)}</td>
                        <td>${r.endedAt ? fmtDateTime(r.endedAt) : "—"} <span class="text-muted">(${dur})</span></td>
                    </tr>
                `;
                }).join("");
            }

            function renderClientComments(card) {
                const list = Array.isArray(card.clientComments) ? card.clientComments : [];
                if (!list.length) return `<div class="text-muted small">Sem comentários do cliente.</div>`;

                return list.map(c => `
                <div class="border rounded p-2">
                    <div class="d-flex justify-content-between">
                        <div class="fw-medium">${escapeHtml(c.author || "Cliente")}</div>
                        <div class="text-muted small">${fmtDateTime(c.at)}</div>
                    </div>
                    <div class="small mt-1">${escapeHtml(c.text)}</div>
                </div>
            `).join("");
            }

            function renderDetailsActions(card) {
                const id = escapeAttr(card.id);
                const actions = [];

                if (card.status === "backlog") {
                    actions.push(`<button class="btn btn-primary kb-start" data-id="${id}"><i class="bx bx-play me-1"></i>Iniciar produção</button>`);
                }

                if (card.status === "doing" || card.status === "changes") {
                    if (card.roles?.design?.active) actions.push(`<button class="btn btn-success kb-role-done" data-role="design" data-id="${id}"><i class="bx bx-check me-1"></i>Concluir arte</button>`);
                    if (card.roles?.text?.active) actions.push(`<button class="btn btn-success kb-role-done" data-role="text" data-id="${id}"><i class="bx bx-check me-1"></i>Concluir legenda/copy</button>`);
                }

                if (card.status === "approval") {
                    actions.push(`<button class="btn btn-success kb-approve" data-id="${id}"><i class="bx bx-check-double me-1"></i>Aprovar</button>`);
                    actions.push(`<button class="btn btn-outline-danger kb-change" data-target="design" data-id="${id}"><i class="bx bx-revision me-1"></i>Alteração: Arte</button>`);
                    actions.push(`<button class="btn btn-outline-danger kb-change" data-target="text" data-id="${id}"><i class="bx bx-revision me-1"></i>Alteração: Legenda/Copy</button>`);
                    actions.push(`<button class="btn btn-outline-danger kb-change" data-target="both" data-id="${id}"><i class="bx bx-revision me-1"></i>Alteração: Geral</button>`);
                }

                if (card.status === "approved" && card.roles?.schedule?.active) {
                    actions.push(`<button class="btn btn-success kb-role-done" data-role="schedule" data-id="${id}"><i class="bx bx-calendar-check me-1"></i>Marcar como agendado</button>`);
                }

                if (card.status === "scheduled") {
                    actions.push(`<button class="btn btn-success kb-publish" data-id="${id}"><i class="bx bx-world me-1"></i>Marcar como publicado</button>`);
                }

                return actions.join("");
            }

            // ========= CRUD =========
            function upsertCardFromForm() {
                const title = ($("#kb-title").value || "").trim();
                if (!title) return showFeedback("Título é obrigatório.", "danger");

                const id = ($("#kb-id").value || "").trim();
                const nowIso = new Date().toISOString();

                const payload = {
                    title,
                    desc: ($("#kb-desc").value || "").trim(),
                    briefing: ($("#kb-briefing").value || "").trim(),

                    client: $("#kb-client").value,
                    priority: $("#kb-priority").value,

                    briefingOwnerId: $("#kb-briefing-owner").value,
                    designOwnerId: $("#kb-role-design").value,
                    textOwnerId: $("#kb-role-text").value,

                    estDesign: Number($("#kb-est-design").value || 0),
                    estText: Number($("#kb-est-text").value || 0),
                    estSchedule: Number($("#kb-est-schedule").value || 0),

                    dueDate: $("#kb-due").value || null,
                    tags: ($("#kb-tags").value || "").split(",").map(s => s.trim()).filter(Boolean).slice(0, 8),
                };

                if (id) {
                    const card = state.cards.find(c => c.id === id);
                    if (!card) return;

                    // atualiza dados base (não mexe no fluxo automaticamente)
                    card.title = payload.title;
                    card.desc = payload.desc;
                    card.briefing = payload.briefing;
                    card.client = payload.client;
                    card.priority = payload.priority;
                    card.dueDate = payload.dueDate;
                    card.tags = payload.tags;

                    card.owners.briefing = payload.briefingOwnerId;
                    card.owners.design = payload.designOwnerId;
                    card.owners.text = payload.textOwnerId;

                    card.roles.design.memberId = payload.designOwnerId;
                    card.roles.text.memberId = payload.textOwnerId;
                    card.roles.schedule.memberId = payload.briefingOwnerId;

                    card.roles.design.estimateHours = payload.estDesign;
                    card.roles.text.estimateHours = payload.estText;
                    card.roles.schedule.estimateHours = payload.estSchedule;

                    card.history.unshift({ id: uid(), type: "edited", at: nowIso });
                } else {
                    const card = makeCard({ ...payload, status: "backlog" });
                    state.cards.unshift(card);
                }

                saveState();
                render();
                modalCreate?.hide();
                showFeedback(id ? "Card atualizado." : "Card criado.", "success");
            }

            function deleteSelected() {
                if (!selectedCardId) return;
                const card = state.cards.find(c => c.id === selectedCardId);
                if (!card) return;

                state.cards = state.cards.filter(c => c.id !== selectedCardId);
                saveState();
                render();
                modalDetails?.hide();
                showFeedback("Card excluído.", "warning");
                selectedCardId = null;
            }

            // ========= Bind events =========
            function bindEvents() {
                $("#kb-open-create")?.addEventListener("click", () => openCreate());
                $("#kb-save")?.addEventListener("click", () => upsertCardFromForm());

                $("#kb-edit-from-details")?.addEventListener("click", () => {
                    if (!selectedCardId) return;
                    const card = state.cards.find(c => c.id === selectedCardId);
                    if (!card) return;
                    modalDetails?.hide();
                    setTimeout(() => openCreate(card), 200);
                });

                $("#kb-delete")?.addEventListener("click", () => deleteSelected());

                // adicionar artes (file)
                $("#kb-add-assets-btn")?.addEventListener("click", () => {
                    if (!selectedCardId) return;
                    $("#kb-assets-file")?.click();
                });

                $("#kb-assets-file")?.addEventListener("change", (e) => {
                    if (!selectedCardId) return;
                    addAssetsFromFiles(selectedCardId, e.target.files);
                    e.target.value = "";
                });

                // salvar copy
                $("#kb-copy-save")?.addEventListener("click", () => {
                    if (!selectedCardId) return;
                    saveCopy(selectedCardId, $("#kb-copy-input").value);
                });

                // client comment add
                $("#kb-client-comment-add")?.addEventListener("click", () => {
                    if (!selectedCardId) return;

                    const card = state.cards.find(c => c.id === selectedCardId);
                    if (!card) return;

                    const tRaw = $("#kb-client-comment-text").value || "";
                    const t = tRaw.trim();
                    if (!t) return;

                    const target = $("#kb-client-comment-target")?.value || "comment";

                    // sempre registra o comentário (estilo Trello)
                    const atIso = new Date().toISOString();
                    card.clientComments.unshift({ id: uid(), at: atIso, author: "Cliente", text: t });
                    card.history.unshift({ id: uid(), type: "client_comment", at: atIso });

                    $("#kb-client-comment-text").value = "";
                    if ($("#kb-client-comment-target")) $("#kb-client-comment-target").value = "comment";

                    // se estiver em aprovação, o comentário pode virar solicitação de alteração
                    if (target !== "comment") {
                        if (card.status !== "approval") {
                            saveState();
                            render();
                            if (selectedCardId === card.id) openDetails(card.id);
                            return showFeedback("Solicitação de alteração só pode ser feita em 'Em aprovação'.", "warning");
                        }

                        const targets = target === "both" ? ["design", "text"] : [target];
                        // requestChange já salva, re-renderiza e mostra feedback
                        return requestChange(card.id, targets);
                    }

                    saveState();
                    render();
                    if (selectedCardId === card.id) openDetails(card.id);
                    showFeedback("Comentário do cliente adicionado.", "info");
                });
                // checklist toggle (mock)
                document.addEventListener("change", (e) => {
                    const t = e.target;
                    if (!t?.classList?.contains("kb-check-item")) return;
                    if (!selectedCardId) return;

                    const card = state.cards.find(c => c.id === selectedCardId);
                    if (!card || !Array.isArray(card.checklist)) return;

                    const item = card.checklist.find(i => i.id === t.dataset.id);
                    if (!item) return;

                    item.done = !!t.checked;
                    saveState();
                    openDetails(selectedCardId);
                });

                // reset mock
                $("#kb-reset-mock")?.addEventListener("click", () => {
                    localStorage.removeItem(STORAGE_KEY);
                    state = loadState();
                    render();
                    showFeedback("Mock resetado.", "info");
                });

                // filtros
                ["#kb-search", "#kb-filter-client", "#kb-filter-member", "#kb-filter-priority"].forEach(sel => {
                    $(sel)?.addEventListener("input", () => render());
                    $(sel)?.addEventListener("change", () => render());
                });

                // metas por cliente (Resultados)
                $("#kb-goals-config")?.addEventListener("click", () => openGoalsModal());
                $("#kb-goals-save")?.addEventListener("click", () => saveGoalsModal());

                modalDetailsEl?.addEventListener("hidden.bs.modal", () => { selectedCardId = null; });
            }

            function bindCardEvents() {
                // Delegação: garante que botões criados dinamicamente (principalmente no modal)
                // funcionem SEM precisar "rebinder" após openDetails().
                if (!bindCardEvents._delegated) {
                    document.addEventListener("click", (e) => {
                        const btn = e.target?.closest?.("button");
                        if (!btn) return;

                        // abrir detalhes
                        if (btn.classList.contains("kb-open-details")) {
                            e.preventDefault();
                            return openDetails(btn.dataset.id);
                        }

                        // concluir role
                        if (btn.classList.contains("kb-role-done")) {
                            e.preventDefault();
                            return completeRole(btn.dataset.id, btn.dataset.role);
                        }

                        // iniciar (backlog → doing)
                        if (btn.classList.contains("kb-start")) {
                            e.preventDefault();
                            const card = state.cards.find(c => c.id === btn.dataset.id);
                            if (!card) return;
                            const atIso = new Date().toISOString();
                            enterStatus(card, "doing", atIso);
                            saveState();
                            render();
                            showFeedback("Card iniciado: Backlog → Em andamento", "success");
                            if (selectedCardId === card.id) openDetails(card.id);
                            return;
                        }

                        // aprovar
                        if (btn.classList.contains("kb-approve")) {
                            e.preventDefault();
                            return approveCard(btn.dataset.id);
                        }

                        // solicitar alteração
                        if (btn.classList.contains("kb-change")) {
                            e.preventDefault();
                            const target = btn.dataset.target;
                            const targets = target === "both" ? ["design", "text"] : [target];
                            return requestChange(btn.dataset.id, targets);
                        }

                        // publicar (scheduled → published)
                        if (btn.classList.contains("kb-publish")) {
                            e.preventDefault();
                            return markPublished(btn.dataset.id);
                        }
                    });

                    bindCardEvents._delegated = true;
                }

                // drag & drop precisa ser re-inicializado após cada render (pois recria DOM)
                initDragAndDrop();
            }

            // ========= Goals =========
            function renderGoals() {
                const cards = state.cards || [];

                const published = cards.filter(c => c.status === "published" && c.publishedAt && c.dueDate);
                const ontime = published.filter(c => isOnTime(c) === true).length;
                const ontimePct = published.length ? Math.round((ontime / published.length) * 100) : 0;

                const qAvg = cards.length ? Math.round(cards.reduce((a, c) => a + calcQuality(c), 0) / cards.length) : 0;
                const reworkTotal = cards.reduce((a, c) => a + Number(c.feedbackCount || 0), 0);

                const TEAM_GOAL_ONTIME = 90;
                const TEAM_GOAL_QUALITY = 85;
                const TEAM_MAX_REWORK = 10;

                $("#goal-team-ontime").textContent = `${ontimePct}% / ${TEAM_GOAL_ONTIME}%`;
                $("#bar-team-ontime").style.width = `${clamp(Math.round((ontimePct / TEAM_GOAL_ONTIME) * 100), 0, 100)}%`;

                $("#goal-team-quality").textContent = `${qAvg} / ${TEAM_GOAL_QUALITY}`;
                $("#bar-team-quality").style.width = `${clamp(Math.round((qAvg / TEAM_GOAL_QUALITY) * 100), 0, 100)}%`;

                $("#goal-team-rework").textContent = `${reworkTotal} / ${TEAM_MAX_REWORK}`;
                $("#bar-team-rework").style.width = `${clamp(Math.round((reworkTotal / TEAM_MAX_REWORK) * 100), 0, 100)}%`;
                $("#bar-team-rework").classList.toggle("bg-danger", reworkTotal > TEAM_MAX_REWORK);

                // por pessoa
                const rows = MOCK_MEMBERS.map(m => {
                    const participated = cards.filter(c => {
                        const o = c.owners || {};
                        const roles = c.roles || {};
                        return o.briefing === m.id || o.design === m.id || o.text === m.id ||
                            roles.design?.memberId === m.id || roles.text?.memberId === m.id || roles.schedule?.memberId === m.id;
                    });

                    const publishedMine = participated.filter(c => c.status === "published" && c.publishedAt && c.dueDate);
                    const ontimeMine = publishedMine.filter(c => isOnTime(c) === true).length;
                    const ontimeMinePct = publishedMine.length ? Math.round((ontimeMine / publishedMine.length) * 100) : 0;

                    const qualityMine = participated.length ? Math.round(participated.reduce((a, c) => a + calcQuality(c), 0) / participated.length) : 0;
                    const reworkMine = participated.reduce((a, c) => a + Number(c.feedbackCount || 0), 0);

                    // estimado e real (somando só o que é atribuído a essa pessoa)
                    let estSum = 0;
                    if (participated.length) {
                        participated.forEach(c => {
                            if (c.roles?.design?.memberId === m.id) estSum += Number(c.roles.design.estimateHours || 0);
                            if (c.roles?.text?.memberId === m.id) estSum += Number(c.roles.text.estimateHours || 0);
                            if (c.roles?.schedule?.memberId === m.id) estSum += Number(c.roles.schedule.estimateHours || 0);
                        });
                    }
                    estSum = Math.round(estSum * 10) / 10;

                    const runs = cards.flatMap(c => Array.isArray(c.roleRuns) ? c.roleRuns : []);
                    let actSum = runs.filter(r => r.memberId === m.id).reduce((a, r) => a + diffHours(r.startedAt, r.endedAt), 0);
                    actSum = Math.round(actSum * 10) / 10;

                    return {
                        memberName: m.name,
                        ontimePct: ontimeMinePct,
                        qualityAvg: qualityMine,
                        reworkTotal: reworkMine,
                        estimateSum: estSum,
                        actualSum: actSum,
                    };
                });

                renderGoalsTableRows(rows);

                renderClientGoals();
            }

            function renderGoalsTableRows(rows) {
                const body = $("#goals-table-body");
                if (!body) return;

                body.innerHTML = rows.map(r => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-2">
                                <span class="avatar-initial rounded bg-label-primary">${escapeHtml(r.memberName.slice(0, 1))}</span>
                            </div>
                            <div class="fw-medium">${escapeHtml(r.memberName)}</div>
                        </div>
                    </td>
                    <td><span class="fw-medium">${r.ontimePct}%</span></td>
                    <td><span class="fw-medium">${r.qualityAvg}</span></td>
                    <td><span class="fw-medium">${r.reworkTotal}</span></td>
                    <td style="min-width:220px;">
                        <div class="small">
                            <span class="text-muted">Σ est:</span> <span class="fw-medium">${r.estimateSum}h</span>
                            <span class="mx-2">•</span>
                            <span class="text-muted">Σ real:</span> <span class="fw-medium">${r.actualSum}h</span>
                        </div>
                        <div class="small text-muted">
                            Desvio: ${r.estimateSum > 0 ? Math.round(((r.actualSum - r.estimateSum) / r.estimateSum) * 100) : 0}%
                        </div>
                    </td>
                </tr>
            `).join("");
            }

            function openGoalsModal() {
                ensureClientGoals();
                const body = $("#kb-goals-table-body");
                if (!body) return;

                body.innerHTML = MOCK_CLIENTS.map(client => {
                    const g = state.clientGoals[client] || {};
                    const c = escapeHtml(client);

                    return `
            <tr data-client="${escapeAttr(client)}">
                <td class="fw-medium">${c}</td>
                <td style="width: 120px;">
                    <input class="form-control form-control-sm" data-field="postsPerMonth" type="number" min="0"
                        value="${Number(g.postsPerMonth ?? 0)}">
                </td>
                <td style="width: 120px;">
                    <input class="form-control form-control-sm" data-field="ontimePct" type="number" min="0" max="100"
                        value="${Number(g.ontimePct ?? 0)}">
                </td>
                <td style="width: 130px;">
                    <input class="form-control form-control-sm" data-field="quality" type="number" min="0" max="100"
                        value="${Number(g.quality ?? 0)}">
                </td>
                <td style="width: 140px;">
                    <input class="form-control form-control-sm" data-field="maxRework" type="number" min="0"
                        value="${Number(g.maxRework ?? 0)}">
                </td>
            </tr>
        `;
                }).join("");

                modalGoals?.show();
            }

            function saveGoalsModal() {
                const body = $("#kb-goals-table-body");
                if (!body) return;

                const rows = Array.from(body.querySelectorAll("tr"));
                rows.forEach(tr => {
                    const client = tr.dataset.client;
                    const postsPerMonth = Number(tr.querySelector('[data-field="postsPerMonth"]')?.value || 0);
                    const ontimePct = Number(tr.querySelector('[data-field="ontimePct"]')?.value || 0);
                    const quality = Number(tr.querySelector('[data-field="quality"]')?.value || 0);
                    const maxRework = Number(tr.querySelector('[data-field="maxRework"]')?.value || 0);

                    state.clientGoals[client] = {
                        postsPerMonth,
                        ontimePct,
                        quality,
                        maxRework,
                    };
                });

                saveState();
                renderGoals();
                modalGoals?.hide();
                showFeedback("Metas por cliente atualizadas.", "success");
            }

            function renderClientGoals() {
                ensureClientGoals();

                const wrap = $("#kb-goals-clients");
                if (!wrap) return;

                const cards = state.cards || [];
                const now = new Date();
                const curM = now.getMonth();
                const curY = now.getFullYear();

                const isPublishedThisMonth = (c) => {
                    if (c.status !== "published" || !c.publishedAt) return false;
                    const d = new Date(c.publishedAt);
                    return d.getMonth() === curM && d.getFullYear() === curY;
                };

                wrap.innerHTML = MOCK_CLIENTS.map(client => {
                    const g = state.clientGoals[client] || {};
                    const cardsClient = cards.filter(c => (c.client || "") === client);
                    const published = cardsClient.filter(isPublishedThisMonth);

                    const postsDone = published.length;
                    const postsGoal = Number(g.postsPerMonth ?? 0);

                    const ontime = published.filter(c => isOnTime(c) === true).length;
                    const ontimePct = published.length ? Math.round((ontime / published.length) * 100) : 0;

                    const qAvg = cardsClient.length
                        ? Math.round(cardsClient.reduce((a, c) => a + calcQuality(c), 0) / cardsClient.length)
                        : 0;

                    const reworkTotal = cardsClient.reduce((a, c) => a + Number(c.feedbackCount || 0), 0);

                    const barPosts = postsGoal ? clamp(Math.round((postsDone / postsGoal) * 100), 0, 100) : 0;
                    const barOntime = Number(g.ontimePct ?? 0) ? clamp(Math.round((ontimePct / Number(g.ontimePct)) * 100), 0, 100) : 0;
                    const barQuality = Number(g.quality ?? 0) ? clamp(Math.round((qAvg / Number(g.quality)) * 100), 0, 100) : 0;
                    const barRework = Number(g.maxRework ?? 0) ? clamp(Math.round((reworkTotal / Number(g.maxRework)) * 100), 0, 100) : 0;

                    return `
            <div class="border rounded p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-medium">${escapeHtml(client)}</div>
                    <span class="badge bg-label-secondary">${postsDone}/${postsGoal || "—"} posts (mês)</span>
                </div>

                <div class="mt-2">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Posts/mês</span><span>${postsDone} / ${postsGoal || "—"}</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: ${barPosts}%"></div>
                    </div>
                </div>

                <div class="mt-2">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>No prazo</span><span>${ontimePct}% / ${Number(g.ontimePct ?? 0)}%</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: ${barOntime}%"></div>
                    </div>
                </div>

                <div class="mt-2">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Qualidade</span><span>${qAvg} / ${Number(g.quality ?? 0)}</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: ${barQuality}%"></div>
                    </div>
                </div>

                <div class="mt-2">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Retrabalho</span><span>${reworkTotal} / ${Number(g.maxRework ?? 0)}</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: ${barRework}%"></div>
                    </div>
                </div>
            </div>
        `;
                }).join("");
            }


            // ========= Init =========
            document.addEventListener("DOMContentLoaded", () => {
                bindEvents();
                render();
            });

        })();
    </script>


</body>

</html>